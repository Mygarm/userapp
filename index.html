<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mygram</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --wa-header-bg: #005c97; /* A deep, rich blue */
            --wa-accent-blue: #34B7F1; /* A vibrant, modern blue for accents */
            --wa-message-out-bg: #e1f6fb; /* A very light blue for sent messages */
            --wa-message-in-bg: #ffffff;
            --wa-app-bg: #f0f2f5; /* Light grey background, common in modern apps */
            --wa-chat-bg: #e5ddd5; /* Classic WhatsApp pattern background color */
            --wa-icon-color: #f0f2f5;
            --wa-text-primary: #111b21;
            --wa-text-secondary: #667781;
            --wa-border-color: #e9edef;
            --wa-active-tab-indicator: var(--wa-accent-blue);
            --wa-button-color: #008069; /* Kept a green shade for buttons for familiarity */
            --wa-link-color: #00a8e8;
            --wa-shadow: rgba(17, 27, 33, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #d1d7db; /* The grey area outside the app */
        }

        body {
            color: var(--wa-text-primary);
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
        
        /* --- General UI Elements --- */
        .icon-btn {
            background: none;
            border: none;
            color: var(--wa-icon-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            position: relative;
        }
        .icon-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .icon-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        
        .text-icon-btn {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            border-radius: 8px;
            border: 1px solid var(--wa-border-color);
            background-color: transparent;
            color: var(--wa-header-bg);
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        .text-icon-btn:hover {
            background-color: var(--wa-app-bg);
        }
        .text-icon-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--wa-header-bg);
        }
        .text-icon-btn.primary {
            background-color: var(--wa-header-bg);
            color: white;
            border-color: var(--wa-header-bg);
        }
        .text-icon-btn.primary svg {
            fill: white;
        }

        #app-container {
            width: 100%;
            height: 100%;
            max-width: 450px;
            max-height: 950px;
            background-color: var(--wa-app-bg);
            box-shadow: 0 12px 28px 0 var(--wa-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            border-radius: 8px;
        }

        .view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #fff;
        }
        .view main {
            width: 100%;
            flex-grow: 1;
            overflow-y: auto;
        }

        .page-header {
             width: 100%;
             padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: var(--wa-header-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-shrink: 0;
            color: var(--wa-icon-color);
        }
        .page-title {
            font-size: 20px;
            font-weight: 500;
            flex-grow: 1; /* Title will take up space */
        }

        /* --- NEW: Loading View --- */
        #loading-view {
            justify-content: center;
            background-color: #fff;
        }
        .loader {
            border: 4px solid var(--wa-app-bg);
            border-top: 4px solid var(--wa-header-bg);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .loader-small {
            border: 2px solid var(--wa-app-bg);
            border-top: 2px solid var(--wa-header-bg);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Auth View --- */
        #auth-view { justify-content: start; overflow-y: auto; padding: 20px; }
        .app-title { font-size: 36px; font-weight: 700; color: var(--wa-header-bg); margin-bottom: 20px; text-align: center; }
        .auth-form { width: 100%; max-width: 380px; display: flex; flex-direction: column; gap: 14px; margin: 0 auto; }
        .auth-form input, .auth-form select { border-radius: 8px; border: 1px solid #ccc; background-color: #fff; color: var(--wa-text-primary); padding: 12px; font-family: 'Roboto', sans-serif; font-size: 16px; width: 100%; transition: border-color 0.2s, box-shadow 0.2s; }
        .auth-form input:focus, .auth-form select:focus { outline: none; border-color: var(--wa-header-bg); box-shadow: 0 0 0 2px rgba(0, 92, 151, 0.2); }
        .auth-form button { border-radius: 8px; background-color: var(--wa-header-bg); color: white; font-weight: 500; font-family: 'Roboto', sans-serif; font-size: 16px; border: none; padding: 14px; cursor: pointer; width: 100%; transition: background-color 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .auth-form button:hover { background-color: #004c7a; }
        .auth-form button:disabled { background-color: #aaa; cursor: not-allowed;}
        .form-switch-text { color: var(--wa-text-secondary); font-size: 14px; text-align: center; margin-top: 10px; }
        .form-switch-text a { color: var(--wa-link-color); text-decoration: none; cursor: pointer; font-weight: 500; }
        .error-message { color: #d93025; font-size: 13px; text-align: center; min-height: 20px; }
        
        /* NEW: Verify Email View Styles */
        #verify-email-view .verify-box {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--wa-shadow);
            max-width: 380px;
        }
        #verify-email-view h2 { color: var(--wa-header-bg); margin-bottom: 15px; }
        #verify-email-view p { margin-bottom: 20px; color: var(--wa-text-secondary); line-height: 1.5; }
        #verify-email-view button { width: 100%; }
        #verify-email-view .secondary-actions { margin-top: 15px; font-size: 14px; }


        /* --- Main View --- */
        #main-view { display: none; }
        header.main-header { width: 100%; background-color: var(--wa-header-bg); padding: 10px 15px 0; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); z-index: 5; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 20px; font-weight: 500; color: var(--wa-icon-color); }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .header-nav { display: flex; justify-content: space-around; margin-top: 10px; }
        .nav-tab { background: none; border: none; color: rgba(255, 255, 255, 0.7); cursor: pointer; padding: 10px 16px; flex-grow: 1; border-bottom: 3px solid transparent; transition: color 0.2s; position: relative; }
        .nav-tab.active { color: var(--wa-active-tab-indicator); }
        .nav-tab.active svg { fill: var(--wa-active-tab-indicator); }
        .nav-tab svg { width: 28px; height: 28px; fill: rgba(255, 255, 255, 0.7); transition: fill 0.2s; }
        .badge { position: absolute; top: -2px; right: -4px; background-color: #d93025; color: white; border-radius: 10px; font-size: 11px; padding: 2px 6px; font-weight: 500; display: none; border: 1px solid var(--wa-header-bg); }

        #main-content { width: 100%; flex-grow: 1; overflow-y: auto; background-color: #fff; position:relative; }
        .content-panel { display: none; }
        .content-panel.active { display: block; }
        .list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; background-color: #fff; border-bottom: 1px solid var(--wa-border-color); transition: background-color 0.2s; }
        .list-item:hover { background-color: var(--wa-app-bg); }
        .list-item:last-child { border-bottom: none; }
        .list-item-profile-img-container { position: relative; margin-right: 15px; }
        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background-color: #4CAF50;
            border-radius: 50%;
            border: 2px solid white;
            display: none; /* Hidden by default */
        }
        .list-item-profile-img { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; background-color: #ccc; }
        .list-item-details { flex-grow: 1; overflow: hidden; }
        .list-item-name { font-weight: 500; font-size: 17px; margin-bottom: 2px; }
        .list-item-subtext { font-size: 14px; color: var(--wa-text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .list-item-actions { display: flex; gap: 10px; }
        .list-item-actions button { background-color: var(--wa-accent-blue); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; }
        .list-item-actions button.reject { background-color: var(--wa-text-secondary); }

        /* --- Notification View --- */
        #notifications-view main { padding-top: 10px; }
        .notification-item {
            display: flex;
            gap: 10px; align-items: center; padding: 10px 15px;
            border-bottom: 1px solid var(--wa-border-color);
            cursor: pointer;
        }
        .notification-item:hover { background-color: var(--wa-app-bg); }
        .notification-item.unread {
            background-color: #e8f0fe; /* A light blue to indicate unread */
        }

        /* --- Modals --- */
        .modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 30; }
        .modal-content { background-color: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
        .modal-content h2 { text-align: center; color: var(--wa-header-bg); font-weight: 500; margin-bottom: 10px; }
        .modal-content label { font-weight: 500; margin-top: 5px; font-size: 14px; }
        .modal-content select, .modal-content textarea, .modal-content input[type="date"], .modal-content input[type="number"], .modal-content input[type="password"], .modal-content input[type="text"] {
            border-radius: 8px; border: 1px solid #ccc; background-color: var(--wa-app-bg); 
            color: var(--wa-text-primary); padding: 12px 15px; font-family: 'Roboto', sans-serif; 
            font-size: 16px; width: 100%;
        }
        .modal-content button { border-radius: 8px; background-color: var(--wa-header-bg); color: white; font-weight: 500; font-family: 'Roboto', sans-serif; font-size: 16px; border: none; padding: 12px 20px; cursor: pointer; width: 100%; }
        .modal-content button:disabled { background-color: #aaa; cursor: not-allowed; }
        .modal-content button.secondary { background-color: var(--wa-text-secondary); }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        .image-upload-label { cursor: pointer; padding: 12px; border: 2px dashed #ccc; border-radius: 8px; text-align: center; color: var(--wa-text-secondary); transition: all 0.2s; }
        .image-upload-label:hover { border-color: var(--wa-header-bg); background-color: #f8f8f8; }
        #qr-code-display { padding: 20px; display: flex; justify-content: center; align-items: center; }
        #image-preview-display img { max-width: 100%; max-height: 50vh; border-radius: 8px; }
        .info-text { font-size: 13px; color: var(--wa-text-secondary); text-align: center; margin-top: -5px; }
        
        /* --- Profile View --- */
        #profile-view main, #user-profile-view main { width: 100%; padding: 0; }
        #profile-info-display, #user-profile-info-display { text-align: center; padding-bottom: 20px; position: relative; }
        .profile-cover-photo { width: 100%; height: 160px; object-fit: cover; background-color: #ccc; }
        .profile-main-info { padding: 0 20px; margin-top: -50px; position: relative; z-index: 2; }
        #profile-info-display img.profile-img, #user-profile-info-display img.profile-img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid #fff; }
        #profile-info-display .name, #user-profile-info-display .name { font-size: 22px; font-weight: 500; margin-top: 5px; }
        #profile-info-display .jgId, #user-profile-info-display .jgId { font-size: 14px; color: var(--wa-text-secondary); }
        
        #profile-options { display: flex; flex-direction: column; gap: 5px; padding: 0 20px 20px; }
        #profile-edit-form { margin-top: 15px; display: flex; flex-direction: column; gap: 10px; padding: 0 20px 20px; }
        /* IMPROVED: Edit Profile Name Input Style */
        #profile-edit-form input[type="text"] {
            border-radius: 8px; border: 1px solid #ccc; background-color: #fff;
            color: var(--wa-text-primary); padding: 14px; font-family: 'Roboto', sans-serif;
            font-size: 16px; width: 100%; transition: border-color 0.2s, box-shadow 0.2s;
        }
        #profile-edit-form input[type="text"]:focus {
            outline: none; border-color: var(--wa-header-bg);
            box-shadow: 0 0 0 2px rgba(0, 92, 151, 0.2);
        }
        
        #profile-stats, #user-profile-stats {
            width: 100%;
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding: 15px 0;
            border-top: 1px solid var(--wa-border-color);
             border-bottom: 1px solid var(--wa-border-color);
        }
        .stat-item {
            text-align: center;
        }
        .stat-item span {
            display: block;
        }
        .stat-item span:first-child {
            font-size: 20px;
            font-weight: 700;
            color: var(--wa-header-bg);
        }
        .stat-item span:last-child {
            font-size: 14px;
            color: var(--wa-text-secondary);
        }
        .blue-badge {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-left: 5px;
            vertical-align: middle;
        }

        /* --- QR Scanner View --- */
        #qr-scanner-view { background-color: #000; }
        #qr-reader { width: 100%; max-width: 500px; }

        /* --- Post Styles --- */
        #posts-content { padding: 0; position: relative; }
        .create-post-container {
            padding: 15px;
            border-bottom: 8px solid var(--wa-app-bg);
            background-color: #fff;
        }
        #post-textarea {
            width: 100%;
            border: 1px solid var(--wa-border-color);
            border-radius: 8px;
            padding: 10px;
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 10px;
        }
        .create-post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        #add-post-image-btn {
            padding: 10px;
            border: none;
            background-color: var(--wa-app-bg);
            color: var(--wa-button-color);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #add-post-image-btn svg {
            width: 20px;
            height: 20px;
            fill: var(--wa-button-color);
        }
        #post-image-preview-container {
            margin-bottom: 10px;
            position: relative;
        }
        #post-image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            display: block;
        }
        #remove-post-image-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .post-image {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
        }
        #create-post-btn {
             width: 100%;
             padding: 12px; border: none; background-color: var(--wa-button-color); color: white; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 15px;
             flex-grow: 1;
        }
        .post-card {
            background-color: #fff;
            border-bottom: 1px solid var(--wa-border-color);
            padding: 15px;
        }
        .post-card.highlight {
            animation: highlight-anim 2s ease-out;
        }
        @keyframes highlight-anim {
            0% { background-color: #e3f2fd; }
            100% { background-color: #fff; }
        }
        .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .post-author-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
        }
        .post-author-info {
             flex-grow: 1;
        }
        .post-author-info .name {
            font-weight: 500;
            cursor: pointer;
        }
        .post-author-info .timestamp {
            font-size: 12px;
            color: var(--wa-text-secondary);
        }
        .sponsored-label {
            font-size: 11px;
            font-weight: 700;
            color: #E77F01;
            text-transform: uppercase;
        }
        .post-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-bottom: 15px;
        }
        .post-content .see-more-btn {
            color: var(--wa-link-color);
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            padding: 0 5px;
        }
        .post-actions {
            display: flex;
            justify-content: space-around;
            border-top: 1px solid var(--wa-border-color);
            padding-top: 8px;
        }
        .post-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--wa-text-secondary);
            font-weight: 500;
            font-size: 14px;
            padding: 8px;
            border-radius: 5px;
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-basis: 0;
            flex-grow: 1;
            justify-content: center;
        }
        .post-action-btn:hover {
            background-color: var(--wa-app-bg);
        }
        .post-action-btn.liked {
            color: var(--wa-accent-blue);
        }
        .post-action-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        .post-comments-section {
            padding: 0 15px 15px;
            background-color: #fff;
            border-bottom: 8px solid var(--wa-app-bg);
        }
        .comment-item {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            position: relative;
        }
        .comment-item:hover .comment-delete-btn { opacity: 1; }
        .comment-delete-btn {
            position: absolute;
            top: 5px; right: 5px;
            font-size: 11px; color: var(--wa-text-secondary);
            cursor: pointer; opacity: 0; transition: opacity 0.2s;
        }
        .comment-author-img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        .comment-content {
            background-color: var(--wa-app-bg);
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 14px;
            width: 100%;
            position: relative;
        }
        .comment-author-name {
            font-weight: 500;
            font-size: 13px;
        }
        .comment-actions {
            font-size: 12px;
            font-weight: 500;
            color: var(--wa-text-secondary);
            margin-top: 4px;
        }
        .comment-actions .reply-btn { cursor: pointer; }
        .reply-item {
            margin-left: 40px;
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }

        /* NEW: Post 3-Dot Menu Styles */
        .post-menu-btn {
            color: var(--wa-text-secondary);
            padding: 4px;
        }
        .post-menu-btn:hover {
            background-color: var(--wa-app-bg);
        }
        .post-menu-btn svg {
             width: 20px; height: 20px;
        }
        .post-dropdown-menu {
            display: none;
            position: absolute;
            top: 30px;
            right: 0;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--wa-shadow);
            z-index: 16; /* Higher than chat menu */
            overflow: hidden;
            width: 180px;
        }
        .post-dropdown-menu button {
            background: none; border: none; padding: 12px 16px; width: 100%;
            text-align: left; cursor: pointer; font-size: 15px; color: var(--wa-text-primary);
        }
        .post-dropdown-menu button:hover {
            background-color: var(--wa-app-bg);
        }
        
        /* NEW: Boost CTA Button Styles */
        .boost-cta-button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border-radius: 8px;
            border: none;
            background-color: var(--wa-button-color);
            color: white;
            font-family: 'Roboto', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
        }
        .boost-cta-button:hover {
            background-color: #006a5a;
        }


        /* My Posts View Styles */
        #my-posts-list .post-card {
            border-bottom: 1px solid var(--wa-border-color);
            padding-bottom: 5px;
        }
        .post-controls {
            display: flex;
            gap: 15px;
            margin-left:auto; /* Pushes the controls to the right */
        }
        .post-control-btn {
            font-size: 13px;
            cursor: pointer;
            font-weight: 500;
        }
        .delete-post-btn { color: #d93025; }
        .edit-post-btn { color: var(--wa-header-bg); }

        /* USER PROFILE VIEW SPECIFIC */
        #user-profile-actions {
            padding: 0 20px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* NEW: Post Image View Modal */
        #post-image-view-modal .modal-content {
            padding: 10px;
        }
        #post-image-view-modal img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
        }
        #post-image-view-modal button {
            width: auto;
            margin-top: 10px;
        }
        
        /* NEW: Video Thumbnail Player Style */
        .video-thumbnail-container {
            position: relative;
            cursor: pointer;
            margin-top: 10px;
        }
        .video-thumbnail-container img {
            width: 100%;
            border-radius: 8px;
            display: block;
        }
        .play-button-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
        }
        .play-button-overlay svg {
            width: 60px;
            height: 60px;
            fill: rgba(255, 255, 255, 0.8);
        }
        
        /* NEW: Video Player Style */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
            margin-top: 10px;
            border-radius: 8px;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }


        /* --- Badge Request View Styles --- */
        #badge-request-view main {
            padding: 20px;
        }
        #badge-packages-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }
        .badge-package-option {
            border: 2px solid var(--wa-border-color);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: box-shadow 0.2s, transform 0.2s, border-color 0.2s;
            cursor: default;
            background-color: #fff;
        }
        .badge-package-option.active {
            border-color: var(--wa-header-bg);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .badge-package-option:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .badge-package-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .badge-package-header h3 {
            color: var(--wa-header-bg);
            margin: 0;
            font-size: 20px;
        }
        .badge-package-icon {
            width: 32px;
            height: 32px;
        }
        .badge-package-features {
            list-style: none;
            padding: 0;
            margin: 15px 0;
            color: var(--wa-text-secondary);
            font-size: 14px;
        }
        .badge-package-features li {
            margin-bottom: 5px;
        }
        .badge-price {
            font-size: 24px;
            font-weight: 700;
            color: var(--wa-button-color);
            margin-bottom: 15px;
        }
        .badge-purchase-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: var(--wa-button-color);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
            line-height: 1.4;
        }
        .badge-purchase-btn:hover {
            background-color: #006a5a;
        }
        .badge-purchase-btn:disabled {
            background-color: #9E9E9E;
            cursor: not-allowed;
            font-size: 12px;
        }

        /* --- Wallet View Styles --- */
        #wallet-view main {
            padding: 20px;
            background-color: var(--wa-app-bg);
        }
        .wallet-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--wa-shadow);
            margin-bottom: 20px;
        }
        .total-balance-card {
            text-align: center;
            background: linear-gradient(45deg, var(--wa-header-bg), var(--wa-accent-blue));
            color: white;
        }
        .total-balance-card .balance-title {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        .total-balance-card .balance-amount {
            font-size: 36px;
            font-weight: 700;
        }
        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--wa-border-color);
        }
        .balance-item:last-child {
            border-bottom: none;
        }
        .balance-item .balance-title {
            font-weight: 500;
        }
        .balance-item .balance-amount {
            font-size: 18px;
            font-weight: 500;
            color: var(--wa-button-color);
        }
        .history-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--wa-shadow);
        }
        .history-section h3 {
            font-size: 18px;
            color: var(--wa-header-bg);
            margin-bottom: 10px;
            border-bottom: 1px solid var(--wa-border-color);
            padding-bottom: 10px;
        }
        .transaction-list {
            padding: 0;
        }
        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--wa-border-color);
        }
        .transaction-item:last-child {
            border-bottom: none;
        }
        .transaction-details .reason {
            font-weight: 500;
            font-size: 15px;
        }
        .transaction-details .timestamp {
            font-size: 12px;
            color: var(--wa-text-secondary);
        }
        .transaction-amount {
            font-weight: 700;
            font-size: 16px;
        }
        .transaction-amount.credit {
            color: #2e7d32;
        }
        .transaction-amount.debit {
            color: #c62828;
        }

        /* NEW: Boost Dashboard Styles */
        #boost-dashboard-view main {
            padding: 20px;
            background-color: var(--wa-app-bg);
        }
        #boost-dashboard-list { display: flex; flex-direction: column; gap: 15px; }
        .boost-dashboard-item {
            background-color: #fff;
            border: 1px solid var(--wa-border-color);
            border-radius: 8px;
            padding: 12px;
        }
        .boost-item-header { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .boost-item-header img { width: 50px; height: 50px; border-radius: 4px; object-fit: cover; }
        .boost-item-details { flex-grow: 1; }
        .boost-item-details p { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; font-size: 14px; margin: 0; }
        .boost-status { font-weight: 700; font-size: 13px; padding: 3px 8px; border-radius: 12px; color: white; }
        .boost-status.pending { background-color: #f57c00; }
        .boost-status.active { background-color: #388e3c; }
        .boost-status.ended { background-color: var(--wa-text-secondary); }
        .boost-status.rejected { background-color: #d32f2f; }

        .boost-item-stats { display: flex; justify-content: space-around; text-align: center; padding: 10px 0; border-top: 1px solid var(--wa-border-color); border-bottom: 1px solid var(--wa-border-color); margin-bottom: 10px; }
        .boost-stat { font-size: 13px; color: var(--wa-text-secondary); }
        .boost-stat span { display: block; font-size: 16px; font-weight: 700; color: var(--wa-text-primary); }
        .boost-item-footer { font-size: 12px; text-align: center; color: var(--wa-text-secondary); }
        
        /* CHAT VIEW STYLES */
        #dm-chat-view {
            display: none;
        }
        #dm-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .message-bubble {
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 75%;
            word-wrap: break-word;
            font-size: 15px;
            position: relative; /* For reactions and menus */
        }
        .message-bubble.deleted {
            background-color: transparent !important;
            font-style: italic;
            color: var(--wa-text-secondary);
            font-size: 13px;
            padding: 4px 12px;
        }
        .message-bubble .message-content-wrapper { position: relative; }
        .message-bubble img.chat-image {
            max-width: 100%;
            border-radius: 15px;
            margin-top: 5px;
            cursor: pointer;
            display: block;
        }
        .message-meta {
            font-size: 11px;
            color: var(--wa-text-secondary);
            margin-top: 4px;
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
        }
        .message-meta .edited-label { font-style: italic; }
        .message-seen-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            object-fit: cover;
        }
        #dm-chat-header-subtext.online {
            color: #90ee90; /* A light, visible green */
            font-weight: 500;
        }
        #dm-chat-header-subtext.offline {
            color: rgba(240, 242, 245, 0.7); /* A muted version of icon color */
        }
        
        .image-container-for-chat {
            position: relative;
        }
        .image-download-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .image-container-for-chat:hover .image-download-btn {
            opacity: 1;
        }
        
        .message-received {
            background-color: var(--wa-message-in-bg);
            align-self: flex-start;
            border-top-left-radius: 4px;
        }
        .message-sent {
            background-color: var(--wa-message-out-bg);
            align-self: flex-end;
            border-top-right-radius: 4px;
        }
        .message-reactions {
            position: absolute;
            bottom: -10px;
            left: 5px;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            border-radius: 10px;
            display: flex;
            gap: 4px;
            padding: 2px 4px;
            font-size: 12px;
        }
        .message-sent .message-reactions { left: auto; right: 5px; }
        .reaction-chip {
            display: flex; align-items: center;
            cursor: pointer;
        }
        .reaction-chip.user-reacted {
            background-color: #e0f0ff;
            padding: 1px 4px;
            border-radius: 8px;
        }
        .message-menu-trigger {
            display: none;
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #fff;
            border-radius: 50%;
            width: 24px; height: 24px;
            align-items: center; justify-content: center;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            font-size: 16px;
            z-index: 5;
        }
        .message-sent:hover .message-menu-trigger { display: flex; }
        .message-menu {
            display: none;
            position: absolute; right: 0; top: 15px;
            background-color: #fff;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            overflow: hidden; z-index: 15;
            width: 100px;
        }
        .message-menu button {
            display: block; width: 100%; text-align: left;
            border: none; background: none; padding: 8px 12px;
            cursor: pointer; font-size: 14px;
        }
        .message-menu button:hover { background-color: #f0f0f0; }

        #dm-chat-input-container {
            padding: 8px 12px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            background-color: var(--wa-app-bg);
            flex-shrink: 0;
        }
        #dm-chat-input {
            flex-grow: 1;
            border-radius: 20px;
            border: 1px solid var(--wa-border-color);
            padding: 10px 15px;
            font-size: 16px;
            resize: none;
            max-height: 100px;
            overflow-y: auto;
        }
        #dm-chat-send-btn {
            border: none;
            background-color: var(--wa-button-color);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* NEW: Settings View Styles */
        #settings-view main {
            padding: 0;
            background-color: var(--wa-app-bg);
        }
        .settings-section {
            background-color: #fff;
            margin-bottom: 8px;
            padding: 0 20px;
        }
        .settings-section h3 {
            padding: 15px 0 10px;
            font-weight: 500;
            color: var(--wa-header-bg);
            font-size: 16px;
        }
        .settings-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--wa-border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .settings-item:last-child {
            border-bottom: none;
        }
        .settings-item:hover {
            background-color: #fafafa;
        }
        .settings-item .icon {
            margin-right: 15px;
            color: var(--wa-text-secondary);
        }
        .settings-item .icon svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        .settings-item .details {
            flex-grow: 1;
        }
        .settings-item .details .title {
            font-size: 16px;
            font-weight: 400;
        }
        .settings-item .details .subtitle {
            font-size: 13px;
            color: var(--wa-text-secondary);
        }
        /* CHANGED: Logout Button Color */
        #logout-btn {
            background-color: var(--wa-text-secondary); /* Changed from red to gray */
            color: white;
            border-color: var(--wa-text-secondary);
            margin: 20px; 
            width: calc(100% - 40px);
        }
        #logout-btn svg { fill: white; }
        #logout-btn:hover { background-color: #5a6871; } /* Darker gray on hover */

    </style>
</head>
<body>
    <div id="app-container">
        <!-- Loading View -->
        <div id="loading-view" class="view">
            <div class="loader"></div>
        </div>

        <!-- Auth View -->
        <div id="auth-view" class="view" style="display: none;">
            
            <form id="login-form" class="auth-form">
                <h1 class="app-title">Mygram</h1>
                <div id="login-error" class="error-message"></div>
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit" id="login-btn">
                    <span class="btn-text">Log In</span>
                    <div class="loader-small" style="display: none;"></div>
                </button>
                <p class="form-switch-text">Don't have an account? <a id="show-signup">Sign up</a></p>
            </form>

            <form id="signup-form" class="auth-form" style="display: none;">
                <h1 class="app-title">Create Account</h1>
                <div id="signup-error" class="error-message"></div>
                <input type="text" id="signup-name" placeholder="Full Name" required>
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Password" required>
                <select id="signup-gender" required>
                    <option value="" disabled selected>Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                </select>
                <input type="date" id="signup-dob" required>
                <input type="file" id="signup-profile-image" accept="image/*" style="display: none;"> 
                <label for="signup-profile-image" class="image-upload-label">Upload Profile Picture (Optional)</label> 
                <input type="file" id="signup-cover-image" accept="image/*" style="display: none;"> 
                <label for="signup-cover-image" class="image-upload-label">Upload Cover Photo (Optional)</label> 
                <input type="text" id="signup-refer-code" placeholder="Refer Code (Optional)">
                <button type="submit" id="signup-submit-btn">Sign Up</button>
                <p class="form-switch-text">Already have an account? <a id="show-login">Log in</a></p>
            </form>
        </div>

        <!-- NEW: Verify Email View -->
        <div id="verify-email-view" class="view" style="display: none;">
            <div class="verify-box">
                <h2>Verify Your Email</h2>
                <p>A verification link has been sent to <strong id="verification-email-display">your email</strong>. Please check your inbox (and spam folder) and click the link to activate your account.</p>
                <button id="resend-verification-btn">Resend Verification Email</button>
                <div class="secondary-actions">
                    <p class="form-switch-text">Wrong email? <a id="logout-from-verify-btn">Log out and sign up again</a>.</p>
                </div>
            </div>
        </div>


        <!-- Main View -->
        <div id="main-view" class="view">
            <header class="main-header">
                <div class="header-top">
                    <span class="header-title">Mygram</span>
                    <div class="header-actions">
                         <button id="search-user-btn" class="icon-btn" title="Search Users">
                            <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
                        </button>
                        <!-- NEW: Add Video Button -->
                        <button id="add-video-btn" class="icon-btn" title="Add Video">
                            <svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                        </button>
                         <button id="notification-btn" class="icon-btn" title="Notifications">
                            <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"></path></svg>
                            <span id="notification-badge" class="badge"></span>
                        </button>
                        <button id="nav-dm-btn" class="icon-btn" title="Messages">
                            <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"></path></svg>
                            <span id="dm-badge" class="badge"></span>
                        </button>
                        <button id="menu-btn" class="icon-btn" title="Profile & Settings" style="padding: 0;">
                            <img id="header-profile-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23f0f2f5'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                        </button>
                    </div>
                </div>
                <div id="search-container" style="display: none; padding: 0 15px 10px;">
                    <input type="text" id="search-input" placeholder="Search by name, ID, or #tag" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--wa-border-color);">
                </div>
                <nav class="header-nav">
                    <button id="nav-posts" class="nav-tab active" title="Posts">
                        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                    </button>
                    <button id="nav-watch" class="nav-tab" title="Watch">
                        <svg viewBox="0 0 24 24"><path d="M10 16.5v-9l6 4.5-6 4.5zM20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12z"/></svg>
                    </button>
                    <button id="nav-groups" class="nav-tab" title="Groups">
                        <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                    </button>
                </nav>
            </header>
        
            <main id="main-content">
                <div id="search-results-container" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: white; z-index: 10; display: none; overflow-y: auto;"></div>
                
                <div id="posts-content" class="content-panel active">
                    <div class="create-post-container">
                        <textarea id="post-textarea" placeholder="What's on your mind?"></textarea>
                        <div id="post-image-preview-container" style="display: none;">
                            <img id="post-image-preview" src="" alt="Image Preview">
                            <button id="remove-post-image-btn">&times;</button>
                        </div>
                        <input type="file" id="post-image-input" accept="image/*" style="display: none;">
                        <div class="create-post-actions">
                             <button id="add-post-image-btn">
                                <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"></path></svg>
                                Photo
                            </button>
                            <button id="create-post-btn">Post</button>
                        </div>
                    </div>
                    <div id="posts-feed"></div>
                </div>
                
                 <div id="watch-content" class="content-panel">
                     <!-- Video posts will be rendered here by JS -->
                </div>

                 <div id="groups-content" class="content-panel">
                    <div style="text-align: center; padding: 50px 20px; color: var(--wa-text-secondary);">
                        <h2>Groups</h2>
                        <p>This feature is coming soon!</p>
                    </div>
                </div>
            </main>
        </div>

        <!-- Notifications View -->
        <div id="notifications-view" class="view" style="display: none;">
             <header class="page-header">
                <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">Notifications</span>
             </header>
            <main>
                <div id="unified-notifications-list"></div>
            </main>
        </div>

        <!-- Direct Messages (DM) List View -->
        <div id="dm-view" class="view" style="display: none;">
            <header class="page-header">
                <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">Messages</span>
            </header>
            <main>
                <div id="dm-list-container" style="width:100%;"></div>
            </main>
        </div>

        <!-- My Posts View -->
        <div id="my-posts-view" class="view" style="display: none;">
             <header class="page-header">
                 <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">My Posts</span>
             </header>
            <main>
                   <div id="my-posts-list" style="width:100%;"></div>
            </main>
        </div>
        
        <!-- Boost Dashboard View -->
        <div id="boost-dashboard-view" class="view" style="display: none;">
            <header class="page-header">
                <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">Boost Dashboard</span>
            </header>
            <main>
                <div id="boost-dashboard-list"></div>
            </main>
        </div>

        <!-- My Profile View -->
        <div id="profile-view" class="view" style="display: none;">
            <header class="page-header">
                <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">My Profile</span>
                <button id="profile-settings-btn" class="icon-btn" title="Settings" style="margin-left: auto;">
                    <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></svg>
                </button>
            </header>
            <main>
                <div id="profile-info-display">
                    <img class="profile-cover-photo" alt="Cover Photo">
                    <div class="profile-main-info">
                        <img class="profile-img" alt="Profile Picture">
                        <div class="name"></div>
                        <div class="jgId"></div>
                    </div>
                </div>
                <div id="profile-stats">
                    <div class="stat-item">
                        <span id="profile-friends-count">0</span>
                        <span>Friends</span>
                    </div>
                    <div class="stat-item">
                        <span id="profile-followers-count">0</span>
                        <span>Followers</span>
                    </div>
                    <div class="stat-item">
                        <span id="profile-likes-count">0</span>
                        <span>Likes</span>
                    </div>
                </div>

                <div id="profile-options">
                     <button id="show-qr-btn" class="text-icon-btn primary">
                        <svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm8-12v8h8V3h-8zm6 6h-4V5h4v4zm-2 12h-4v-2h2v-2h2v4zM13 13h-2v2h2v-2zm4 0h-2v2h2v-2zm-2 2h-2v2h2v-2zm4 0h-2v2h2v-2zm2-4h-2v2h2v-2zm0-2h-2v2h2v-2zm-2 6h-2v2h2v-2zm-6-4h2v-2h-2v2z"></path></svg>
                        <span>My Profile QR</span>
                    </button>
                    <button id="boost-dashboard-btn" class="text-icon-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path></svg>
                        <span>Boost Dashboard</span>
                    </button>
                    <button id="request-badge-btn" class="text-icon-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M22.5 12.5c0-1.28-.21-2.5-.6-3.63l-1.32.76c.28.89.42 1.83.42 2.87s-.14 1.98-.42 2.87l1.32.76c.39-1.13.6-2.35.6-3.63zm-2.48-5.32c-.52-.9-1.16-1.72-1.9-2.43l-1.13 1.13c.59.57 1.1 1.25 1.52 2.01l1.51-.71zM12 4c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm-1.04 11.45l-2.83-2.83.71-.71 2.12 2.12 4.95-4.95.71.71-5.66 5.66zM4.98 7.18l1.51.71c.42-.76.93-1.44 1.52-2.01L6.88 4.75c-.74.71-1.38 1.53-1.9 2.43zM2.1 8.87l1.32-.76C3.02 9.22 2.9 10.16 2.9 11.1s.12 1.88.33 2.78l-1.32-.76C1.51 12.04 1.3 11.09 1.3 10.1s.21-1.94.6-2.87zm16.92 7.66l-1.51-.71c-.42.76-.93 1.44-1.52 2.01l1.13 1.13c.74-.71 1.38-1.53 1.9-2.43z"></path></svg>
                        <span>Request Badge</span>
                    </button>
                     <button id="view-my-posts-btn" class="text-icon-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"></path></svg>
                        <span>My Post</span>
                    </button>
                     <button id="edit-profile-btn" class="text-icon-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg>
                        <span>Edit My Profile</span>
                     </button>
                </div>

                <div id="profile-edit-form" style="display:none;">
                    <input type="text" id="edit-profile-name">
                     <input type="file" id="edit-profile-image" accept="image/*" style="display:none;">
                    <label for="edit-profile-image" class="image-upload-label">Change Picture</label>
                    <input type="file" id="edit-profile-cover" accept="image/*" style="display:none;">
                    <label for="edit-profile-cover" class="image-upload-label">Change Cover Photo</label>
                    <button id="save-profile-changes-btn" class="text-icon-btn primary" style="margin-top: 10px;">Save Changes</button>
                </div>
            </main>
        </div>
        
        <!-- Settings View -->
        <div id="settings-view" class="view" style="display: none;">
            <header class="page-header">
                <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">Settings</span>
            </header>
            <main>
                <div class="settings-section">
                    <div id="change-email-item" class="settings-item">
                        <div class="icon"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg></div>
                        <div class="details">
                            <div class="title">Email Address</div>
                            <div class="subtitle" id="settings-current-email"></div>
                        </div>
                    </div>
                    <div id="change-password-item" class="settings-item">
                        <div class="icon"><svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg></div>
                        <div class="details">
                            <div class="title">Change Password</div>
                        </div>
                    </div>
                </div>
                 <div class="settings-section">
                    <div id="my-wallet-item" class="settings-item">
                        <div class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"></path></svg></div>
                        <div class="details">
                            <div class="title">My Wallet</div>
                        </div>
                    </div>
                    <div id="referral-program-item" class="settings-item">
                        <div class="icon"><svg viewBox="0 0 24 24"><path d="M16.5 12c1.38 0 2.5-1.12 2.5-2.5S17.88 7 16.5 7C15.12 7 14 8.12 14 9.5s1.12 2.5 2.5 2.5zM9 11c1.66 0 2.99-1.34 2.99-3S10.66 5 9 5C7.34 5 6 6.34 6 8s1.34 3 3 3zm7.5 3c-1.83 0-5.5.92-5.5 2.75V19h11v-2.25c0-1.83-3.67-2.75-5.5-2.75zM9 13c-2.33 0-7 1.17-7 3.5V19h7v-2.25c0-.85.33-2.34 2.37-3.41C10.5 13.1 9.66 13 9 13z"/></svg></div>
                        <div class="details">
                            <div class="title">Referral Program</div>
                            <div class="subtitle">Total Referrals: <span id="total-referrals-count">0</span></div>
                        </div>
                    </div>
                    <div id="add-friend-item" class="settings-item">
                        <div class="icon"><svg viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg></div>
                        <div class="details">
                            <div class="title">Add Friend</div>
                            <div class="subtitle">Add new friends by ID or QR code</div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div id="change-dob-item" class="settings-item">
                         <div class="icon"><svg viewBox="0 0 24 24"><path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/></svg></div>
                        <div class="details">
                            <div class="title">Change Date of Birth</div>
                             <div class="subtitle">Can only be changed once</div>
                        </div>
                    </div>
                    <div id="change-gender-item" class="settings-item">
                         <div class="icon"><svg viewBox="0 0 24 24"><path d="M12 4c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm0 1.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5 1.5zM12 20c-2.21 0-4-1.79-4-4h2c0 1.1.9 2 2 2s2-.9 2-2h2c0 2.21-1.79 4-4 4zm-4-6H6v-2h2c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2h-2c0-1.1-.9-2-2-2s-2 .9-2 2 .9 2 2 2zm8 0h2v-2h-2c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2h2c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2z"/></svg></div>
                        <div class="details">
                            <div class="title">Change Gender</div>
                            <div class="subtitle">Can only be changed once</div>
                        </div>
                    </div>
                    <div id="copy-profile-url-item" class="settings-item">
                        <div class="icon"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></div>
                        <div class="details">
                            <div class="title">Copy Profile URL</div>
                        </div>
                    </div>
                </div>

                <div id="blocked-users-section" class="settings-section">
                     <h3>Blocked Users</h3>
                    <div id="blocked-users-list" style="max-height: 150px; overflow-y: auto;"></div>
                </div>
                
                <button id="logout-btn" class="text-icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"></path></svg>
                    <span>Logout</span>
                </button>
            </main>
        </div>

        
        <!-- Other User Profile View -->
        <div id="user-profile-view" class="view" style="display: none;">
            <header class="page-header">
                <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span id="user-profile-page-title" class="page-title">Profile</span>
            </header>
            <main>
                <div id="user-profile-info-display">
                     <img class="profile-cover-photo" alt="Cover Photo">
                     <div class="profile-main-info">
                        <img class="profile-img" alt="Profile Picture">
                        <div class="name"></div>
                     </div>
                </div>
                <div id="user-profile-stats">
                     <div class="stat-item">
                        <span id="user-profile-friends-count">0</span>
                        <span>Friends</span>
                    </div>
                    <div class="stat-item">
                        <span id="user-profile-followers-count">0</span>
                        <span>Followers</span>
                    </div>
                    <div class="stat-item">
                        <span id="user-profile-likes-count">0</span>
                        <span>Likes</span>
                    </div>
                </div>
                <div id="user-profile-actions">
                    <button id="follow-user-btn" class="text-icon-btn primary">
                        <!-- Content will be set by JS -->
                    </button>
                    <button id="user-profile-friend-btn" class="text-icon-btn">
                        <!-- Content will be set by JS -->
                    </button>
                    <button id="user-profile-block-btn" class="text-icon-btn">
                        <!-- Content will be set by JS -->
                    </button>
                    <button id="user-profile-show-qr-btn" class="text-icon-btn">
                         <svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm8-12v8h8V3h-8zm6 6h-4V5h4v4zm-2 12h-4v-2h2v-2h2v4zM13 13h-2v2h2v-2zm4 0h-2v2h2v-2zm-2 2h-2v2h2v-2zm4 0h-2v2h2v-2zm2-4h-2v2h2v-2zm0-2h-2v2h2v-2zm-2 6h-2v2h2v-2zm-6-4h2v-2h-2v2z"></path></svg>
                        <span>Show QR Code</span>
                    </button>
                </div>
                <h3 style="padding: 15px 20px 5px; font-weight: 500; color: var(--wa-header-bg); border-top: 8px solid var(--wa-app-bg);">Recent Posts</h3>
                <div id="user-profile-posts-list" style="width:100%;"></div>
            </main>
        </div>

        <!-- User's All Posts View -->
        <div id="user-all-posts-view" class="view" style="display: none;">
             <header class="page-header">
                 <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span id="user-all-posts-title" class="page-title">All Posts</span>
             </header>
            <main>
                <div id="user-all-posts-list" style="width:100%;"></div>
            </main>
        </div>


        <!-- QR Scanner View -->
        <div id="qr-scanner-view" class="view" style="display: none;">
             <header class="page-header">
                  <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">Scan QR Code</span>
             </header>
             <main style="justify-content: center; align-items:center; background: #333;">
                <div id="qr-reader"></div>
            </main>
        </div>
        
        <!-- DM Chat View -->
        <div id="dm-chat-view" class="view" style="display: none;">
            <header class="page-header">
                <button class="back-btn icon-btn">
                     <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <div class="list-item-profile-img-container">
                    <img id="dm-chat-header-img" class="list-item-profile-img" alt="Profile Pic">
                    <div id="dm-chat-online-indicator" class="online-indicator"></div>
                </div>
                <div id="dm-chat-header-info" class="list-item-details">
                    <div id="dm-chat-header-name" class="list-item-name"></div>
                     <div id="dm-chat-header-subtext" class="list-item-subtext"></div>
                </div>
            </header>

            <main id="dm-chat-messages" style="background-color: var(--wa-chat-bg);"></main>

            <footer id="dm-chat-input-container">
                 <input type="file" id="dm-image-input" accept="image/*" style="display: none;">
                 <button id="dm-attach-btn" class="icon-btn" style="color: var(--wa-text-secondary); background-color: white; border-radius: 50%; width: 44px; height: 44px; flex-shrink: 0;">
                    <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"></path></svg>
                </button>
                <textarea id="dm-chat-input" placeholder="Message" rows="1"></textarea>
                <button id="dm-chat-send-btn">
                     <svg viewBox="0 0 24 24" fill="white" width="24px" height="24px"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                </button>
            </footer>
        </div>
        
        <!-- Badge Request View -->
        <div id="badge-request-view" class="view" style="display: none;">
            <header class="page-header">
                <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">Request a Badge</span>
            </header>
            <main>
                <p style="text-align: center; color: var(--wa-text-secondary); margin-bottom: 20px;">
                    Choose a package to get a verified blue badge and post with images.
                </p>
                <div id="badge-packages-container">
                    <!-- Package options will be dynamically inserted here by JavaScript -->
                </div>
            </main>
        </div>

        <!-- Wallet View -->
        <div id="wallet-view" class="view" style="display: none;">
            <header class="page-header">
                <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">My Wallet</span>
                 <div class="header-actions" style="margin-left:auto;">
                    <button id="withdraw-money-btn" class="icon-btn" title="Withdraw Money">
                        <svg viewBox="0 0 24 24"><path d="M3,11H5.5L2,7.5L5.5,4H3V11M22,5V19A2,2 0 0,1 20,21H7A2,2 0 0,1 5,19V16H7V19H20V5H7V8H5V5A2,2 0 0,1 7,3H20A2,2 0 0,1 22,5Z"></path></svg>
                    </button>
                    <button id="add-money-btn" class="icon-btn" title="Add Money">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"></path></svg>
                    </button>
                 </div>
            </header>
            <main>
                <div class="wallet-card total-balance-card">
                    <div class="balance-title">Total Balance</div>
                    <div class="balance-amount" id="wallet-total-balance">$0.00</div>
                </div>

                <div class="wallet-card">
                    <div class="balance-item">
                        <span class="balance-title">Main Balance</span>
                        <span class="balance-amount" id="wallet-main-balance">$0.00</span>
                    </div>
                     <div class="balance-item">
                        <span class="balance-title">Refer Balance</span>
                        <span class="balance-amount" id="wallet-refer-balance">$0.00</span>
                    </div>
                     <div class="balance-item">
                        <span class="balance-title">Coupon Balance</span>
                        <span class="balance-amount" id="wallet-coupon-balance">$0.00</span>
                    </div>
                </div>
                
                <div class="history-section">
                    <h3 style="display:flex; justify-content:space-between; align-items:center;">
                        All History
                        <div>
                             <button id="download-history-btn" class="icon-btn" title="Download History" style="color: var(--wa-header-bg);">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>
                            </button>
                            <button id="reload-history-btn" class="icon-btn" title="Reload History" style="color: var(--wa-header-bg);">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
                            </button>
                        </div>
                    </h3>
                    <div class="transaction-list" id="wallet-history-list">
                        <!-- History items will be inserted here -->
                    </div>
                </div>

            </main>
        </div>
        
        <!-- Modals -->
        <div id="add-friend-modal" class="modal"> <div class="modal-content"> <h2>Add Friend</h2> <p>Enter your friend's Mygram ID (e.g., jg-1234)</p> <div style="display:flex; gap:10px; align-items:center;"> <input type="text" id="add-friend-id-input" placeholder="jg-xxxx" style="flex-grow:1;"> <button id="scan-qr-btn" class="icon-btn" title="Scan QR Code" style="color: var(--wa-header-bg); flex-shrink:0; width:44px; height:44px; background-color: var(--wa-app-bg);"><svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm8-12v8h8V3h-8zm6 6h-4V5h4v4zm-2 12h-4v-2h2v-2h2v4zM13 13h-2v2h2v-2zm4 0h-2v2h2v-2zm-2 2h-2v2h2v-2zm4 0h-2v2h2v-2zm2-4h-2v2h2v-2zm0-2h-2v2h2v-2zm-2 6h-2v2h2v-2zm-6-4h2v-2h-2v2z"></path></svg></button> </div> <div class="modal-actions"> <button id="close-add-friend-modal-btn" class="secondary">Cancel</button> <button id="send-friend-request-btn">Send Request</button> </div> </div> </div>
        <div id="qr-code-modal" class="modal"> <div class="modal-content"> <h2>Scan this Code</h2> <div id="qr-code-display"></div> <p style="text-align:center; font-size:16px; font-weight:500;" id="qr-code-text"></p> <button id="close-qr-modal-btn" class="secondary">Close</button> </div> </div>
        <div id="exit-confirm-modal" class="modal"> <div class="modal-content"> <h2>Exit App?</h2> <p style="text-align:center;">Are you sure you want to exit?</p> <div class="modal-actions" style="justify-content:space-around;"> <button id="exit-no-btn" class="secondary">No</button> <button id="exit-yes-btn">Yes</button> </div> </div> </div>
        
        <div id="boost-post-modal" class="modal">
            <div class="modal-content">
                <h2>Boost Post</h2>
                <label for="boost-days-input">Select duration (days):</label>
                <input type="number" id="boost-days-input" value="1" min="1" max="30">

                <label for="boost-button-type-select">Button Type (Optional):</label>
                <select id="boost-button-type-select">
                    <option value="none" selected>None</option>
                    <option value="watch">Watch</option>
                    <option value="download">Download</option>
                    <option value="visit">Visit</option>
                    <option value="view_more">View More</option>
                </select>

                <div id="boost-link-container" style="display: none; width:100%; display:none; flex-direction:column; gap: 5px;">
                    <label for="boost-button-link-input" id="boost-link-label">Button Link (URL):</label>
                    <input type="text" id="boost-button-link-input" placeholder="https://example.com">
                </div>

                <p style="text-align: center; font-weight: 500; margin-top: 10px;">
                    Total Cost: $<span id="boost-total-cost">1.00</span>
                </p>
                <div class="modal-actions">
                    <button id="close-boost-modal-btn" class="secondary">Cancel</button>
                    <button id="confirm-boost-btn">Boost Now</button>
                </div>
            </div>
        </div>
        
        <div id="edit-post-modal" class="modal">
            <div class="modal-content">
                <h2>Edit Post</h2>
                <textarea id="edit-post-textarea" rows="6"></textarea>
                <div class="modal-actions">
                    <button id="close-edit-modal-btn" class="secondary">Cancel</button>
                    <button id="save-edit-post-btn">Save Changes</button>
                </div>
            </div>
        </div>
        <div id="post-image-view-modal" class="modal">
            <div class="modal-content">
                <img id="post-image-view-src" src="" alt="Post Image">
                <div class="modal-actions" style="justify-content: flex-end;">
                    <button id="close-post-image-view-btn" class="secondary">Close</button>
                </div>
            </div>
        </div>
        <div id="add-money-modal" class="modal">
            <div class="modal-content">
                <h2>Add Money with Redeem Code</h2>
                <div id="redeem-message" class="error-message"></div>
                <input type="text" id="redeem-code-input" placeholder="Enter Redeem Code" required>
                <select id="balance-type-select" required>
                    <option value="main" selected>Add to Main Balance</option>
                    <option value="coupon">Add to Coupon Balance</option>
                </select>
                <div class="modal-actions">
                    <button id="close-add-money-modal-btn" class="secondary">Cancel</button>
                    <button id="confirm-redeem-btn">Redeem</button>
                </div>
            </div>
        </div>
        
        <!-- NEW: Add Video Modal -->
        <div id="add-video-modal" class="modal">
            <div class="modal-content">
                <h2>Post a Video</h2>
                <p class="info-text" style="margin-bottom: 10px;">Enter a title, thumbnail, and your Google Drive video's download ID.</p>
                <input type="text" id="video-title-input" placeholder="Video Title" required>
                <input type="text" id="gdrive-id-input" placeholder="Google Drive Download ID" required>
                <input type="file" id="video-thumbnail-input" accept="image/*" style="display:none;">
                <label for="video-thumbnail-input" class="image-upload-label">Upload Thumbnail</label>
                <div class="modal-actions">
                    <button id="close-add-video-modal-btn" class="secondary">Cancel</button>
                    <button id="submit-video-post-btn">Post Video</button>
                </div>
            </div>
        </div>

        <div id="change-password-modal" class="modal">
            <div class="modal-content">
                <h2>Change Password</h2>
                <div id="change-password-error" class="error-message"></div>
                <input type="password" id="current-password-input" placeholder="Current Password" required>
                <input type="password" id="new-password-input" placeholder="New Password" required>
                <input type="password" id="confirm-password-input" placeholder="Confirm New Password" required>
                 <p class="form-switch-text" style="margin: 0;"><a id="forgot-password-link">Forgot Password?</a></p>
                <div class="modal-actions">
                    <button id="close-change-password-modal-btn" class="secondary">Cancel</button>
                    <button id="save-new-password-btn">Save</button>
                </div>
            </div>
        </div>
        
        <div id="referral-modal" class="modal">
            <div class="modal-content">
                <h2>Referral Program</h2>
                <p class="info-text" style="margin-bottom: 10px;">Share your code or link. When a new user signs up, you both get $0.20!</p>
                <label for="referral-code-input">Your Referral Code:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="referral-code-input" readonly>
                    <button id="copy-referral-code-btn" style="width: auto;">Copy</button>
                </div>
                <label for="referral-link-input">Your Referral Link:</label>
                 <div style="display: flex; gap: 10px;">
                    <input type="text" id="referral-link-input" readonly>
                    <button id="copy-referral-link-btn" style="width: auto;">Copy</button>
                </div>
                <div class="modal-actions" style="justify-content: center;">
                    <button id="close-referral-modal-btn" class="secondary" style="width: auto; padding: 10px 30px;">Close</button>
                </div>
            </div>
        </div>
        
        <div id="withdraw-modal" class="modal">
            <div class="modal-content">
                <h2>Withdraw Money</h2>
                 <div id="withdraw-error" class="error-message"></div>
                <p class="info-text" style="margin-bottom: 10px;">Available for withdraw (from Main Balance): <strong id="withdraw-available-balance">$0.00</strong></p>
                <label for="withdraw-amount-input">Amount (USD):</label>
                <input type="number" id="withdraw-amount-input" placeholder="Minimum $10.00">
                <label for="withdraw-method-select">Payment Method:</label>
                <select id="withdraw-method-select">
                    <option value="Bkash">Bkash</option>
                    <option value="Nogad">Nogad</option>
                    <option value="Rocket">Rocket</option>
                </select>
                <label for="withdraw-account-input">Account Number:</label>
                <input type="text" id="withdraw-account-input" placeholder="e.g., 01712345678">

                <div class="modal-actions">
                    <button id="close-withdraw-modal-btn" class="secondary">Cancel</button>
                    <button id="submit-withdraw-request-btn">Submit Request</button>
                </div>
            </div>
        </div>
        
        <div id="image-preview-send-modal" class="modal">
            <div class="modal-content">
                <h2>Send Image</h2>
                <div id="image-preview-send-display" style="text-align: center;">
                    <img id="image-preview-send-src" src="" alt="Image Preview" style="max-width: 100%; max-height: 50vh; border-radius: 8px;">
                </div>
                <div class="modal-actions">
                    <button id="cancel-send-image-btn" class="secondary">Cancel</button>
                    <button id="confirm-send-image-btn">Send</button>
                </div>
            </div>
        </div>

     </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = { apiKey: "AIzaSyA2BfcS9qjzdT70cEcM4kMqDLfzInbMloY", authDomain: "textsms-6bc0b.firebaseapp.com", databaseURL: "https://textsms-6bc0b-default-rtdb.firebaseio.com", projectId: "textsms-6bc0b", storageBucket: "textsms-6bc0b.appspot.com", messagingSenderId: "259023315417", appId: "1:259023315417:web:f335e5ffec03ef390179c8", measurementId: "G-6FV78CN212" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- CLOUDINARY CONFIG ---
        const cloudinaryConfig = { cloudName: "dzmo138qb", uploadPreset: "textsms" };
        
        // --- GLOBAL STATE ---
        let currentUser = null, currentDmPartner = null;
        let totalNotifications = 0, currentView = 'loading-view', html5QrCode = null, scannerMode = null;
        let postImageFile = null; 
        let chatImageFile = null; // For image preview
        let badgePackagesConfig = null;
        let appInitialized = false;
        let boostCostPerDay = 1.00; 
        let postIntersectionObserver;
        let allUsersCache = []; // Cache for user search
        const notificationSound = new Audio('data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaW5nIGN1cmV6YUBnbWFpbC5jb20AAAARTGF2ZjU2LjQwLjEwMQAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAA/gwgYwAAA+gwgYwAADAmgwgYwAAAAAAAAAAAAAAA2cIAAAAAAAAAAAAAAAAAAAAAAADAAAAAAAAAADD/2/9//tAwAAAAAAAAAAAAAAAAAAAAAAA/gwgYwAAA+gwgYwAADAmgwgYwAAAAAAAAAAAAAAA2cIAAAAAAAAAAAAAAAAAAAAAAADAAAAAAAAAADD/2/9//tAwAAAAAAAAAAAAAAAAAAAAAAA/gwgYwAAA+gwgYwAADAmgwgYwAAAAAAAAAAAAAAA2cIAAAAAAAAAAAAAAAAAAAAAAADAAAAAAAAAADD/2/9//tAwAAAAAAAAAAAAAAAAAAAAAAA/gwgYwAAA+gwgYwAADAmgwgYwAAAAAAAAAAAAAAA2cIAAAAAAAAAAAAAAAAAAAAAAADAAAAAAAAAADD/2/9//tAwAAAAAAAAAAAAAAAAAAAAAAA/gwgYwAAA+gwgYwAADAmgwgYwAAAAAAAAAAAAAAA2cIAAAAAAAAAAAAAAAAAAAAAAADAAAAAAAAAADD/2/9//tAwAAAAAAAAAAAAAAAAAAAAAAA/gwgYwAAA+gwgYwAADAmgwgYwAAAAAAAAAAAAAAA2cIAAAAAAAAAAAAAAAAAAAAAAADAAAAAAAAAADD/2/9');

        // --- HARDCODED CONFIGURATION ---
        const hardcodedBadgePackagesConfig = {
            "silver": {
                "name": "Silver Package",
                "priceUSD": 0.39,
                "durationDays": 7,
                "postLimitPerDay": 10,
                "iconColor": "#A9A9A9"
            },
            "gold": {
                "name": "Gold Package",
                "priceUSD": 0.59,
                "durationDays": 15,
                "postLimitPerDay": 10,
                "iconColor": "#FFD700"
            },
            "diamond": {
                "name": "Diamond Package",
                "priceUSD": 0.99,
                "durationDays": 30,
                "postLimitPerDay": 10,
                "iconColor": "#b9f2ff"
            }
        };

        // --- UI ELEMENT SELECTORS ---
        const allViews = document.querySelectorAll('.view');
        const allContentPanels = document.querySelectorAll('.content-panel');
        
        // --- NAVIGATION ---
        const _internalShowView = (viewId) => {
            currentView = viewId;
            allViews.forEach(v => v.style.display = 'none');
            const viewElement = document.getElementById(viewId);
            if (viewElement) {
                viewElement.style.display = 'flex';
                // Trigger view-specific load functions
                if (viewId === 'profile-view') openProfileView();
                if (viewId === 'settings-view') openSettingsView();
                if (viewId === 'wallet-view') renderWalletView();
                if (viewId === 'badge-request-view') renderBadgePackages();
                if (viewId === 'boost-dashboard-view') renderBoostDashboard();
                if (viewId === 'notifications-view') renderUnifiedNotifications();
                if (viewId === 'dm-view') renderDmList();
            }
        };

        const showView = (viewId, pushState = true) => {
            if (currentView !== viewId) {
                _internalShowView(viewId);
                if (pushState) {
                    history.pushState({ view: viewId }, '', `#${viewId}`);
                }
            }
        };

        const goBack = () => {
            history.back();
        };
        
        const showModal = (modalId, show = true) => { document.getElementById(modalId).style.display = show ? 'flex' : 'none'; };
        const showPanel = (panelId) => {
            allContentPanels.forEach(p => p.classList.remove('active'));
            document.getElementById(panelId).classList.add('active');
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            if (panelId === 'posts-content') document.getElementById('nav-posts').classList.add('active'); 
            if (panelId === 'watch-content') {
                document.getElementById('nav-watch').classList.add('active');
                renderWatchContent();
            }
            if (panelId === 'groups-content') document.getElementById('nav-groups').classList.add('active'); 
        };

        // --- UTILITY FUNCTIONS ---
        const generateJgId = () => `jg-${Math.floor(1000 + Math.random() * 9000)}`;
        const escapeHTML = (str) => str ? str.replace(/[&<>"']/g, (match) => ({'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#x27;'}[match])) : '';
        
        const linkify = (inputText) => {
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            const hashtagRegex = /(#\w+)/g;
            const mentionRegex = /(@\w+)/g;
            let processedText = escapeHTML(inputText);
            processedText = processedText.replace(urlRegex, (url) => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
            processedText = processedText.replace(hashtagRegex, (hashtag) => `<a href="#" onclick="searchByTag(event, '${hashtag}')" style="color:var(--wa-link-color); text-decoration:none;">${hashtag}</a>`);
            processedText = processedText.replace(mentionRegex, (match, usernameWithAt) => {
                const username = usernameWithAt.substring(1); 
                return `<a href="#" onclick="openProfileByUsername(event, '${username}')" style="color:var(--wa-link-color); text-decoration:none; font-weight: 500;">${usernameWithAt}</a>`;
            });
            return processedText;
        };

        window.openProfileByUsername = (event, username) => {
            event.preventDefault(); 
            db.ref('users').orderByChild('name').equalTo(username).once('value', snapshot => {
                if (snapshot.exists()) {
                    const userId = Object.keys(snapshot.val())[0];
                    showView('user-profile-view');
                    openUserProfileView(userId);
                } else {
                    alert(`User "${username}" not found.`);
                }
            });
        };

        window.searchByTag = (event, tag) => {
            event.preventDefault(); 
            const searchInput = document.getElementById('search-input');
            const searchContainer = document.getElementById('search-container');
            showView('main-view');
            searchContainer.style.display = 'block';
            searchInput.value = tag;
            searchInput.focus();
            handleSearch({target: searchInput});
        }
        
        function formatNumber(num) {
            if (isNaN(num)) return num;
            if (num >= 1000000000) return (num / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
            return num;
        }

        async function uploadImage(file) { if (!file) return null; if (!cloudinaryConfig.cloudName || !cloudinaryConfig.uploadPreset) { alert("Cloudinary is not configured."); return null; } const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', cloudinaryConfig.uploadPreset); try { const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, { method: 'POST', body: formData }); const data = await response.json(); return data.secure_url ? data.secure_url : Promise.reject(data.error.message); } catch (error) { console.error('Cloudinary upload failed:', error); alert(`Image upload failed: ${error.message}`); return null; } }

        const getBlueBadgeIcon = (hasBadge) => {
            if (!hasBadge) return '';
            // New SVG for Facebook/Meta style verified badge
            return `<svg class="blue-badge" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="color: #1877f2;">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1.05 13.54l-3.18-3.18c-.31-.31-.31-.82 0-1.13s.82-.31 1.13 0l2.62 2.62 5.25-5.25c.31-.31.82-.31 1.13 0s.31.82 0 1.13l-5.81 5.81c-.16.16-.36.24-.57.24s-.41-.08-.57-.24z"></path>
                    </svg>`;
        };

        async function calculateTotalLikes(userId) {
            let totalLikes = 0;
            const postsRef = db.ref('posts').orderByChild('authorUid').equalTo(userId);
            const snapshot = await postsRef.once('value');
            if (snapshot.exists()) {
                snapshot.forEach(postSnapshot => {
                    if (postSnapshot.hasChild('reactions/like')) {
                        totalLikes += postSnapshot.child('reactions/like').numChildren();
                    }
                });
            }
            return totalLikes;
        }
        
        // --- AUTHENTICATION & APP INITIALIZATION ---
        auth.onAuthStateChanged(user => { 
            if (user) { 
                if (!user.emailVerified) {
                    document.getElementById('verification-email-display').textContent = user.email;
                    showView('verify-email-view', false);
                    return;
                }

                const userRef = db.ref(`users/${user.uid}`);
                userRef.on('value', (snapshot) => { 
                    if (snapshot.exists()) { 
                        currentUser = { uid: user.uid, ...snapshot.val() }; 
                        
                        const headerImg = document.getElementById('header-profile-img');
                        if (headerImg) headerImg.src = currentUser.profileImageUrl;
                        
                        if (!appInitialized) {
                            initializeApp(); 
                            appInitialized = true;
                        } else {
                            handleReferralBonusOnLogin();
                        }
                        
                        if (currentView === 'loading-view' || currentView === 'auth-view' || currentView === 'verify-email-view') {
                            const urlHash = window.location.hash;
                             if (urlHash.startsWith('#post?id=')) {
                                const postId = urlHash.split('?id=')[1];
                                showView('main-view');
                                showPanel('posts-content');
                                goToPost(postId);
                            } else if (urlHash.startsWith('#user-profile-view?id=')) {
                                const userId = urlHash.split('?id=')[1];
                                if (userId) {
                                    showView('user-profile-view');
                                    openUserProfileView(userId);
                                }
                            } else {
                                showView('main-view', false); 
                            }
                        }
                    } else { 
                        auth.signOut(); 
                    } 
                }); 
            } else { 
                currentUser = null;
                appInitialized = false; 
                showView('auth-view', false);
                handleReferralUrl();
            } 
        });

        function handleReferralUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode) {
                const referInput = document.getElementById('signup-refer-code');
                if (referInput) {
                    referInput.value = refCode;
                    referInput.readOnly = true;
                }
            }
        }
        
        function setupBackButtonHandler() {
            history.replaceState({view: 'main-view'}, '', '#main-view');

            window.onpopstate = (event) => {
                if (!currentUser) return;
                if (html5QrCode && html5QrCode.isScanning) html5QrCode.stop();
                
                if (event.state && event.state.view) {
                    _internalShowView(event.state.view);
                } else {
                    if (currentView !== 'main-view') {
                        showView('main-view', true);
                    } else {
                        showModal('exit-confirm-modal');
                        history.pushState({view: 'main-view'}, '', '#main-view');
                    }
                }
            };
            document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', goBack));
        }

        document.getElementById('exit-yes-btn').addEventListener('click', () => { showModal('exit-confirm-modal', false); history.back(); });
        document.getElementById('exit-no-btn').addEventListener('click', () => showModal('exit-confirm-modal', false));

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = document.getElementById('login-btn');
            const btnText = btn.querySelector('.btn-text');
            const loader = btn.querySelector('.loader-small');

            btn.disabled = true;
            btnText.style.display = 'none';
            loader.style.display = 'block';

            auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value)
                .catch(err => {
                    document.getElementById('login-error').textContent = err.message;
                })
                .finally(() => {
                    btn.disabled = false;
                    btnText.style.display = 'inline';
                    loader.style.display = 'none';
                });
        });

        
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errDiv = document.getElementById('signup-error');
            const submitBtn = document.getElementById('signup-submit-btn');
            errDiv.textContent = '';
            
            const name = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const gender = document.getElementById('signup-gender').value;
            const dob = document.getElementById('signup-dob').value;
            const profileFile = document.getElementById('signup-profile-image').files[0];
            const coverFile = document.getElementById('signup-cover-image').files[0];
            const referCode = document.getElementById('signup-refer-code').value.trim();

            if (!name || !email || !password || !gender || !dob) {
                errDiv.textContent = "Please fill all required fields.";
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = "Signing up...";

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                await user.sendEmailVerification();
                document.getElementById('verification-email-display').textContent = user.email;

                const profileImageUrl = await uploadImage(profileFile);
                const coverImageUrl = await uploadImage(coverFile);
                const profileData = {
                    name, email, gender, dob,
                    profileImageUrl: profileImageUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`,
                    coverImageUrl: coverImageUrl || '',
                    jgId: generateJgId(),
                    contacts: {}, blocked: {}, followers: {}, following: {},
                    hasBlueBadge: false,
                    wallet: { main: 0, refer: 0, coupon: 0 },
                    badgeInfo: { packageType: 'free', expiryTimestamp: 0 },
                    dobChanged: false,
                    genderChanged: false,
                    referralBonusCredited: false
                };

                if (referCode) {
                    const usersRef = db.ref('users');
                    const snapshot = await usersRef.orderByChild('jgId').equalTo(referCode).limitToFirst(1).once('value');
                    if (snapshot.exists()) {
                        const referrerUid = Object.keys(snapshot.val())[0];
                        profileData.referredBy = referrerUid;
                    }
                }

                await db.ref(`users/${user.uid}`).set(profileData);
                showView('verify-email-view');

            } catch (err) {
                errDiv.textContent = err.message;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = "Sign Up";
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => { auth.signOut(); });
        document.getElementById('show-signup').addEventListener('click', () => { document.getElementById('login-form').style.display = 'none'; document.getElementById('signup-form').style.display = 'flex'; });
        document.getElementById('show-login').addEventListener('click', () => { document.getElementById('signup-form').style.display = 'none'; document.getElementById('login-form').style.display = 'flex'; });
        document.getElementById('logout-from-verify-btn').addEventListener('click', () => auth.signOut());
        document.getElementById('resend-verification-btn').addEventListener('click', (e) => {
            const btn = e.target;
            btn.disabled = true;
            btn.textContent = "Sending...";
            auth.currentUser.sendEmailVerification()
                .then(() => {
                    alert("Verification email sent! Check your inbox.");
                    btn.textContent = "Resend Verification Email";
                    btn.disabled = false;
                })
                .catch(error => {
                    alert("Error: " + error.message);
                    btn.textContent = "Resend Verification Email";
                    btn.disabled = false;
                });
        });
        
        async function handleReferralBonusOnLogin() {
            if (currentUser && currentUser.referredBy && !currentUser.referralBonusCredited) {
                const newUserId = currentUser.uid;
                const referrerUid = currentUser.referredBy;
                const newUserName = currentUser.name;

                const referrerSnap = await db.ref(`users/${referrerUid}`).once('value');
                if (!referrerSnap.exists()) {
                    await db.ref(`users/${newUserId}/referralBonusCredited`).set(true);
                    return;
                }

                const referralBonus = 0.20;
                const updates = {};
                updates[`/users/${newUserId}/wallet/main`] = firebase.database.ServerValue.increment(referralBonus);
                updates[`/users/${referrerUid}/wallet/refer`] = firebase.database.ServerValue.increment(referralBonus);
                
                const newUserTxKey = db.ref(`transactionHistory/${newUserId}`).push().key;
                updates[`/transactionHistory/${newUserId}/${newUserTxKey}`] = { amount: referralBonus, reason: "Sign-up bonus from referral", timestamp: firebase.database.ServerValue.TIMESTAMP };
                
                const referrerTxKey = db.ref(`transactionHistory/${referrerUid}`).push().key;
                updates[`/transactionHistory/${referrerUid}/${referrerTxKey}`] = { amount: referralBonus, reason: `Referral bonus from ${newUserName}`, timestamp: firebase.database.ServerValue.TIMESTAMP };
                
                updates[`/users/${newUserId}/referralBonusCredited`] = true;

                await db.ref().update(updates);
                
                createNotification(newUserId, 'welcome_bonus', `আপনি সাইনআপ করার জন্য $${referralBonus.toFixed(2)} ফ্রী পেয়েছেন।`, null);
                createNotification(referrerUid, 'referral_bonus', `${newUserName} joined using your referral. You earned $${referralBonus.toFixed(2)}!`, null);
            }
        }
        
        function loadBadgePackageConfig() {
            badgePackagesConfig = hardcodedBadgePackagesConfig;
        }
        
        // --- REAL-TIME PRESENCE ---
        function setupPresenceSystem() {
            const myUid = currentUser.uid;
            const userStatusDatabaseRef = db.ref('/status/' + myUid);

            const isOfflineForDatabase = {
                state: 'offline',
                last_changed: firebase.database.ServerValue.TIMESTAMP,
            };

            const isOnlineForDatabase = {
                state: 'online',
                last_changed: firebase.database.ServerValue.TIMESTAMP,
            };

            db.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val() === false) {
                    return;
                };

                userStatusDatabaseRef.onDisconnect().set(isOfflineForDatabase).then(() => {
                    userStatusDatabaseRef.set(isOnlineForDatabase);
                });
            });
        }


        function initializeApp() {
            loadBadgePackageConfig();
            setupPresenceSystem();
            handleReferralBonusOnLogin();
            listenForFriendRequests();
            listenAndRenderPosts(); // UPDATE: Simplified post loading
            listenForNotifications();
            listenForDms();
            listenForAdminActions();
            checkExpiries();
            setupBackButtonHandler();
            setupIntersectionObserver();
            setupSearch();
            setupSettingsListeners();
            setupWalletActionListeners();
            setupVideoModal();
        }

        // --- UI NAVIGATION LISTENERS ---
        document.getElementById('nav-posts').addEventListener('click', () => {
            showPanel('posts-content');
        });
        document.getElementById('nav-watch').addEventListener('click', () => showPanel('watch-content'));
        document.getElementById('nav-groups').addEventListener('click', () => showPanel('groups-content'));
        document.getElementById('menu-btn').addEventListener('click', () => showView('profile-view'));
        document.getElementById('nav-dm-btn').addEventListener('click', () => showView('dm-view'));
        document.getElementById('notification-btn').addEventListener('click', () => showView('notifications-view'));
        document.getElementById('request-badge-btn').addEventListener('click', () => showView('badge-request-view'));
        document.getElementById('my-wallet-item').addEventListener('click', () => showView('wallet-view'));
        document.getElementById('boost-dashboard-btn').addEventListener('click', () => showView('boost-dashboard-view'));
        document.getElementById('close-add-friend-modal-btn').addEventListener('click', () => showModal('add-friend-modal', false));
        document.getElementById('close-post-image-view-btn').addEventListener('click', () => showModal('post-image-view-modal', false));


        // --- QR Code & Scanner ---
        document.getElementById('show-qr-btn').addEventListener('click', () => { const qrDisplay = document.getElementById('qr-code-display'); qrDisplay.innerHTML = ''; new QRCode(qrDisplay, { text: currentUser.jgId, width: 200, height: 200 }); document.getElementById('qr-code-text').textContent = currentUser.jgId; showModal('qr-code-modal'); });
        document.getElementById('close-qr-modal-btn').addEventListener('click', () => showModal('qr-code-modal', false));
        function startScanner(mode) { scannerMode = mode; showView('qr-scanner-view'); html5QrCode = new Html5Qrcode("qr-reader"); html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess).catch(err => alert("QR Code scanning failed. Please grant camera permissions.")); }
        document.getElementById('scan-qr-btn').addEventListener('click', () => startScanner('addUser'));
        function onScanSuccess(decodedText, decodedResult) { if (html5QrCode && html5QrCode.isScanning) { html5QrCode.stop(); } if (scannerMode === 'addUser') { showModal('add-friend-modal', false); sendFriendRequestById(decodedText); } goBack();}

        // --- FRIEND REQUESTS ---
        function sendFriendRequestById(friendId) { if (!friendId) return; db.ref('users').orderByChild('jgId').equalTo(friendId).once('value', snapshot => { if (snapshot.exists()) { const friendUid = Object.keys(snapshot.val())[0]; if(friendUid === currentUser.uid) { alert("You can't add yourself."); return; } db.ref(`users/${friendUid}`).once('value', friendSnap => { const friendData = friendSnap.val(); const request = { name: currentUser.name, profileImageUrl: currentUser.profileImageUrl, type: 'incoming' }; db.ref(`requests/${friendUid}/${currentUser.uid}`).set(request).then(() => { alert('Friend request sent!'); }); }); } else { alert('User not found.'); } }); }
        document.getElementById('send-friend-request-btn').addEventListener('click', () => { const friendId = document.getElementById('add-friend-id-input').value.trim(); sendFriendRequestById(friendId); showModal('add-friend-modal', false); document.getElementById('add-friend-id-input').value = ''; });
        
        // --- NOTIFICATIONS & FRIEND REQUESTS ---
        function updateNotificationBadge() {
            db.ref(`notifications/${currentUser.uid}`).orderByChild('read').equalTo(false).once('value', notifSnapshot => {
                const unreadPostNotifs = notifSnapshot.numChildren();
                db.ref(`requests/${currentUser.uid}`).once('value', requestSnapshot => {
                    let incomingRequestCount = 0;
                    if(requestSnapshot.exists()) {
                        requestSnapshot.forEach(child => { if(child.val().type === 'incoming') incomingRequestCount++; });
                    }
                    totalNotifications = unreadPostNotifs + incomingRequestCount;
                    const badge = document.getElementById('notification-badge');
                    badge.textContent = totalNotifications;
                    badge.style.display = totalNotifications > 0 ? 'block' : 'none';
                });
            });
        }
        
        function listenForNotifications() {
            const notificationsRef = db.ref(`notifications/${currentUser.uid}`);
            notificationsRef.on('child_added', child => {
                const notif = { id: child.key, ...child.val() };
                if (appInitialized && !notif.read) {
                    notificationSound.play().catch(e => console.log("Audio play failed, user interaction needed."));
                }
                updateNotificationBadge();
            });
            notificationsRef.on('child_changed', () => updateNotificationBadge());
            notificationsRef.on('child_removed', () => updateNotificationBadge());
            notificationsRef.once('value', () => updateNotificationBadge());
        }

        function listenForFriendRequests() {
            db.ref(`requests/${currentUser.uid}`).on('value', () => {
                updateNotificationBadge();
            });
        }
        
        async function renderUnifiedNotifications() {
            const container = document.getElementById('unified-notifications-list');
            container.innerHTML = '<p style="text-align:center; color: #667781; padding: 20px;">Loading notifications...</p>';

            let allNotifications = [];

            const notifSnap = await db.ref(`notifications/${currentUser.uid}`).orderByChild('timestamp').once('value');
            if (notifSnap.exists()) {
                notifSnap.forEach(child => {
                    allNotifications.push({
                        id: child.key,
                        type: 'post',
                        data: { id: child.key, ...child.val() },
                        timestamp: child.val().timestamp
                    });
                });
            }

            const reqSnap = await db.ref(`requests/${currentUser.uid}`).once('value');
            if (reqSnap.exists()) {
                reqSnap.forEach(child => {
                     allNotifications.push({
                        id: child.key,
                        type: 'friend_request',
                        data: { id: child.key, ...child.val() },
                        timestamp: Date.now()
                    });
                });
            }
            
            allNotifications.sort((a, b) => b.timestamp - a.timestamp);
            
            container.innerHTML = '';
            if (allNotifications.length === 0) {
                 container.innerHTML = '<p style="text-align:center; color: #667781; padding: 20px;">No notifications.</p>';
                 return;
            }

            allNotifications.forEach(item => {
                if(item.type === 'post') {
                    const notification = item.data;
                    const div = document.createElement('div');
                    div.id = `notif-${notification.id}`;
                    div.className = 'notification-item';
                    if (!notification.read) div.classList.add('unread');
                    div.onclick = (event) => goToPostFromNotification(notification.postId, notification.id, event);
                    
                    let fromUserImage = notification.fromUserImage || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'%23ccc\'%3E%3Cpath d=\'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z\'/%3E%3C/svg%3E';
                    div.innerHTML = `<img src="${fromUserImage}" class="list-item-profile-img" style="width:40px; height:40px;" alt="P"><div class="list-item-details"><div class="list-item-name">${escapeHTML(notification.fromUserName || 'System') }</div><div class="list-item-subtext">${escapeHTML(notification.text)}</div></div>`;
                    container.appendChild(div);
                }
                else if (item.type === 'friend_request') {
                    const request = item.data;
                    const fromUid = item.id;
                     if (currentUser.blocked && currentUser.blocked[fromUid]) return;
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.style.cursor = 'default';
                    
                    const type = request.type || 'incoming';
                    switch (type) {
                        case 'incoming':
                            div.classList.add('unread');
                            div.innerHTML = `<img src="${request.profileImageUrl}" class="list-item-profile-img" alt="P"><div class="list-item-details"><div class="list-item-name">${request.name}</div><div class="list-item-subtext">Wants to be your friend</div></div><div class="list-item-actions"><button onclick="handleFriendRequest('${fromUid}', true)">Accept</button><button class="reject" onclick="handleFriendRequest('${fromUid}', false)">Reject</button></div>`;
                            break;
                        case 'accepted':
                            div.innerHTML = `<img src="${request.profileImageUrl}" class="list-item-profile-img" alt="P"><div class="list-item-details"><div class="list-item-name">${request.name}</div><div class="list-item-subtext">Accepted your friend request.</div></div><div class="list-item-actions"><button class="reject" onclick="dismissNotification('requests', '${fromUid}')">Dismiss</button></div>`;
                            break;
                        case 'rejected':
                            div.innerHTML = `<img src="${request.profileImageUrl}" class="list-item-profile-img" alt="P"><div class="list-item-details"><div class="list-item-name">${request.name}</div><div class="list-item-subtext">Declined your friend request.</div></div><div class="list-item-actions"><button class="reject" onclick="dismissNotification('requests', '${fromUid}')">Dismiss</button></div>`;
                            break;
                    }
                    if(div.innerHTML) container.appendChild(div);
                }
            });
        }
        
        window.dismissNotification = (type, notificationId) => { db.ref(`${type}/${currentUser.uid}/${notificationId}`).remove().then(renderUnifiedNotifications); };
        window.handleFriendRequest = (fromUid, accepted) => { db.ref(`requests/${currentUser.uid}/${fromUid}`).remove(); const notification = { name: currentUser.name, profileImageUrl: currentUser.profileImageUrl, type: accepted ? 'accepted' : 'rejected' }; db.ref(`requests/${fromUid}/${currentUser.uid}`).set(notification); if (accepted) { db.ref(`users/${currentUser.uid}/contacts/${fromUid}`).set(true); db.ref(`users/${fromUid}/contacts/${currentUser.uid}`).set(true); } renderUnifiedNotifications(); };
        
        
        // --- PROFILE, BADGE & WALLET ---
        async function openProfileView() { 
            const hasActiveBadge = currentUser.badgeInfo && currentUser.badgeInfo.expiryTimestamp > Date.now();
            const display = document.getElementById('profile-info-display'); 
            display.querySelector('.profile-cover-photo').src = currentUser.coverImageUrl || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; 
            display.querySelector('.profile-img').src = currentUser.profileImageUrl; 
            display.querySelector('.name').innerHTML = `${escapeHTML(currentUser.name)} ${getBlueBadgeIcon(hasActiveBadge)}`; 
            display.querySelector('.jgId').textContent = `ID: ${currentUser.jgId}`; 
            document.getElementById('profile-friends-count').textContent = formatNumber(Object.keys(currentUser.contacts || {}).length); 
            document.getElementById('profile-followers-count').textContent = formatNumber(Object.keys(currentUser.followers || {}).length); 
            document.getElementById('profile-likes-count').textContent = '...'; 
            calculateTotalLikes(currentUser.uid).then(totalLikes => { document.getElementById('profile-likes-count').textContent = formatNumber(totalLikes); }); 
            document.getElementById('edit-profile-name').value = currentUser.name; 
            document.getElementById('profile-options').style.display = 'flex'; 
            document.getElementById('profile-edit-form').style.display = 'none'; 
        }

        function renderBadgePackages() {
            const container = document.getElementById('badge-packages-container');
            container.innerHTML = '';
            if (!badgePackagesConfig) {
                container.innerHTML = '<p style="text-align:center;">Packages are currently unavailable.</p>';
                return;
            }

            const hasActivePackage = currentUser.badgeInfo && currentUser.badgeInfo.expiryTimestamp > Date.now();
            const activePackageType = hasActivePackage ? currentUser.badgeInfo.packageType : null;

            const packageIcons = { silver: `<svg class="badge-package-icon" viewBox="0 0 24 24" fill="${badgePackagesConfig.silver.iconColor || '#A9A9A9'}"><path d="M12 2L9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2z"></path></svg>`, gold: `<svg class="badge-package-icon" viewBox="0 0 24 24" fill="${badgePackagesConfig.gold.iconColor || '#FFD700'}"><path d="M12 2L9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2z"></path></svg>`, diamond: `<svg class="badge-package-icon" viewBox="0 0 24 24" fill="${badgePackagesConfig.diamond.iconColor || '#b9f2ff'}"><path d="M12.1 1.14l-10 4.83c-.38.18-.6.58-.6.99v10.08c0 .41.22.81.6.99l10 4.83c.38.18.82.18 1.2 0l10-4.83c.38-.18.6-.58-.6-.99V7c0-.41-.22.81-.6-.99l-10-4.83c-.38-.19-.82-.19-1.2 0zM12 4.24l7.47 3.6L12 11.33 4.53 7.84 12 4.24zM3 8.81l8 3.86v8.46L3 17.19V8.81zm18 0v8.38l-8 3.94v-8.46l8-3.86z"></path></svg>` };

            for (const packageId in badgePackagesConfig) {
                const package = badgePackagesConfig[packageId];
                const packageDiv = document.createElement('div');
                packageDiv.className = 'badge-package-option';

                if (hasActivePackage && packageId === activePackageType) {
                    packageDiv.classList.add('active');
                }

                let buttonHtml;
                if (hasActivePackage) {
                    buttonHtml = `<button class="badge-purchase-btn" disabled>You already have an active package. You cannot purchase a new one until your current package expires.</button>`;
                } else {
                    buttonHtml = `<button class="badge-purchase-btn" onclick="purchaseBadge('${packageId}')">Purchase Now</button>`;
                }

                packageDiv.innerHTML = `<div class="badge-package-header">${packageIcons[packageId] || ''}<h3>${escapeHTML(package.name)}</h3></div><ul class="badge-package-features"><li>${package.durationDays} দিনের জন্য Blue badge</li><li>দিনে ${package.postLimitPerDay} টি করে ছবিসহ পোস্ট</li></ul><div class="badge-price">$${package.priceUSD.toFixed(2)}</div>${buttonHtml}`;
                container.appendChild(packageDiv);
            }
        }
        
        async function purchaseBadge(packageId) {
            if (!badgePackagesConfig || !badgePackagesConfig[packageId]) return alert("Could not find package details.");
            
            const package = badgePackagesConfig[packageId];
            const cost = package.priceUSD;

            if (!confirm(`Confirm purchase of ${package.name} for $${cost.toFixed(2)}? This amount will be deducted from your wallet (Coupon > Refer > Main).`)) return;
            
            const paymentResult = await deductFunds(cost, `Badge: ${package.name}`);
            if (!paymentResult.success) {
                alert(paymentResult.message);
                return;
            }

            try {
                const updates = paymentResult.updates;
                const newRequestKey = db.ref('badgeRequests').push().key;
                updates[`badgeRequests/${newRequestKey}`] = {
                    userId: currentUser.uid,
                    userName: currentUser.name,
                    jgId: currentUser.jgId,
                    packageName: package.name,
                    packageId: packageId,
                    durationDays: package.durationDays,
                    costUSD: cost,
                    status: 'pending',
                    requestedAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                await db.ref().update(updates);
                alert(`Purchase successful! Your request for the ${package.name} has been sent for admin activation.`);
                
            } catch (error) {
                alert("An error occurred during purchase. Please try again.");
                console.error("Badge purchase failed: ", error);
            }
        }
        window.purchaseBadge = purchaseBadge;
        
        function renderWalletView() {
            const wallet = currentUser.wallet || { main: 0, refer: 0, coupon: 0 };
            document.getElementById('wallet-main-balance').textContent = `$${(wallet.main || 0).toFixed(2)}`;
            document.getElementById('wallet-refer-balance').textContent = `$${(wallet.refer || 0).toFixed(2)}`;
            document.getElementById('wallet-coupon-balance').textContent = `$${(wallet.coupon || 0).toFixed(2)}`;
            document.getElementById('wallet-total-balance').textContent = `$${((wallet.main || 0) + (wallet.refer || 0) + (wallet.coupon || 0)).toFixed(2)}`;
            
            const historyList = document.getElementById('wallet-history-list');
            historyList.innerHTML = '<p style="text-align: center; padding: 20px;">Loading history...</p>';
            
            const historyRef = db.ref(`transactionHistory/${currentUser.uid}`).orderByChild('timestamp').limitToLast(50);
            
            historyRef.once('value', snapshot => {
                historyList.innerHTML = '';
                if (!snapshot.exists()) {
                    historyList.innerHTML = '<p style="text-align: center; padding: 20px;">No recent transactions found.</p>';
                    return;
                }
                let transactions = [];
                snapshot.forEach(child => transactions.push(child.val()));
                transactions.reverse().forEach(tx => {
                    const item = document.createElement('div');
                    item.className = 'transaction-item';
                    const amountClass = tx.amount > 0 ? 'credit' : 'debit';
                    const amountSign = tx.amount > 0 ? '+' : '';
                    item.innerHTML = `<div class="transaction-details"><div class="reason">${escapeHTML(tx.reason)}</div><div class="timestamp">${new Date(tx.timestamp).toLocaleString()}</div></div><div class="transaction-amount ${amountClass}">${amountSign}$${Math.abs(tx.amount).toFixed(2)}</div>`;
                    historyList.appendChild(item);
                });
            });
        }
        
        document.getElementById('edit-profile-btn').addEventListener('click', () => { document.getElementById('profile-options').style.display = 'none'; document.getElementById('profile-edit-form').style.display = 'flex'; });
        document.getElementById('save-profile-changes-btn').addEventListener('click', async () => { const button = document.getElementById('save-profile-changes-btn'); button.disabled = true; button.textContent = "Saving..."; const newName = document.getElementById('edit-profile-name').value.trim(); const imageFile = document.getElementById('edit-profile-image').files[0]; const coverFile = document.getElementById('edit-profile-cover').files[0]; let updates = {}; if (newName) updates.name = newName; if (imageFile) { const newImageUrl = await uploadImage(imageFile); if (newImageUrl) updates.profileImageUrl = newImageUrl; } if (coverFile) { const newCoverUrl = await uploadImage(coverFile); if (newCoverUrl) updates.coverImageUrl = newCoverUrl; } db.ref(`users/${currentUser.uid}`).update(updates).then(() => { alert("Profile updated successfully!"); button.disabled = false; button.textContent = "Save Changes"; openProfileView(); }).catch(err => { alert("Update failed: " + err.message); button.disabled = false; button.textContent = "Save Changes"; }); });
        document.addEventListener('click', () => { 
            document.querySelectorAll('.post-dropdown-menu, .message-menu').forEach(m => m.style.display = 'none'); 
        });
        
        window.unblockUser = (uidToUnblock) => { db.ref(`users/${currentUser.uid}/blocked/${uidToUnblock}`).remove().then(() => { alert('User unblocked.'); renderBlockedUsers(); }); }
        function renderBlockedUsers() { const list = document.getElementById('blocked-users-list'); list.innerHTML = ''; db.ref(`users/${currentUser.uid}/blocked`).once('value', snapshot => { if (!snapshot.exists()) { list.innerHTML = '<p style="font-size:12px; text-align:center; color: #667781;">No users blocked.</p>'; return; } snapshot.forEach(childSnapshot => { db.ref(`users/${childSnapshot.key}`).once('value', userSnap => { if (userSnap.exists()) { const user = userSnap.val(); const item = document.createElement('div'); item.className = 'list-item'; item.innerHTML = `<img src="${user.profileImageUrl}" class="list-item-profile-img" alt="U"><div class="list-item-details"><div class="list-item-name">${user.name}</div></div><div class="list-item-actions"><button onclick="unblockUser('${childSnapshot.key}')">Unblock</button></div>`; list.appendChild(item); } }); }); }); }
        
        // --- POST FEATURE FUNCTIONS ---
        // UPDATE: Simplified post feed logic with visibility checks
        function listenAndRenderPosts() {
            const postsRef = db.ref('posts');
            const feed = document.getElementById('posts-feed');
            
            postsRef.orderByChild('timestamp').on('child_added', (snapshot) => {
                if(shouldShowPost(snapshot.val())) {
                    renderSinglePost(snapshot, feed, true);
                }
            });

            postsRef.on('child_changed', (snapshot) => {
                const postElement = document.getElementById(`post-${snapshot.key}`);
                if (postElement) {
                    if (shouldShowPost(snapshot.val())) {
                        renderSinglePost(snapshot, feed, false, postElement);
                    } else {
                        postElement.remove(); // Remove if it no longer meets criteria
                    }
                }
            });

            postsRef.on('child_removed', (snapshot) => {
                const postElement = document.getElementById(`post-${snapshot.key}`);
                if (postElement) postElement.remove();
            });
        }

        // UPDATE: Function to decide if a post should be shown
        function shouldShowPost(postData) {
            if (!postData || postData.hasVideo) return false; // Exclude video posts
            const isMyPost = postData.authorUid === currentUser.uid;
            const isFriend = currentUser.contacts && currentUser.contacts[postData.authorUid];
            const isFollowing = currentUser.following && currentUser.following[postData.authorUid];
            const isBoosted = postData.boostInfo && postData.boostInfo.status === 'active' && postData.boostInfo.endDate > Date.now();
            
            return isMyPost || isFriend || isFollowing || isBoosted;
        }


        document.getElementById('add-post-image-btn').addEventListener('click', () => { document.getElementById('post-image-input').click(); });
        document.getElementById('post-image-input').addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; postImageFile = file; const reader = new FileReader(); reader.onload = (event) => { document.getElementById('post-image-preview').src = event.target.result; document.getElementById('post-image-preview-container').style.display = 'block'; }; reader.readAsDataURL(file); });
        document.getElementById('remove-post-image-btn').addEventListener('click', () => { resetPostImageSelection(); });
        function resetPostImageSelection() { postImageFile = null; const input = document.getElementById('post-image-input'); input.value = ''; document.getElementById('post-image-preview-container').style.display = 'none'; document.getElementById('post-image-preview').src = ''; }
        
        document.getElementById('create-post-btn').addEventListener('click', async () => {
            const hasActivePackage = currentUser.badgeInfo && currentUser.badgeInfo.expiryTimestamp && currentUser.badgeInfo.expiryTimestamp > Date.now();
            if (postImageFile && !hasActivePackage) {
                alert('ছবিসহ পোস্ট করতে অনুগ্রহ করে আপনার প্যাকেজ আপগ্রেড করুন।');
                showView('badge-request-view');
                return;
            }

            const postBtn = document.getElementById('create-post-btn');
            const textArea = document.getElementById('post-textarea');
            const text = textArea.value.trim();
            if (!text && !postImageFile) { return alert("Post cannot be empty. Please add text or an image."); }
            postBtn.disabled = true; postBtn.textContent = 'Posting...';
            const postData = { authorUid: currentUser.uid, authorName: currentUser.name, authorProfileImageUrl: currentUser.profileImageUrl, timestamp: firebase.database.ServerValue.TIMESTAMP };
            try {
                if (postImageFile) {
                    const imageUrl = await uploadImage(postImageFile);
                    if (imageUrl) { postData.imageUrl = imageUrl; } else { throw new Error("Image upload failed."); }
                }
                if (text) { postData.text = text; }
                await db.ref('posts').push(postData);
                textArea.value = ''; resetPostImageSelection();
            } catch (err) { alert(err.message || "Could not create post."); } 
            finally { postBtn.disabled = false; postBtn.textContent = 'Post'; }
        });
        
        async function renderSinglePost(snapshot, containerElement, prepend = true, replaceElement = null) {
            const postId = snapshot.key;
            const postData = snapshot.val();
            if (!postData) return;
            if (!replaceElement && document.getElementById(`post-${postId}`)) return;

            const userSnap = await db.ref(`users/${postData.authorUid}`).once('value');
            let authorHasBadge = false;
            if (userSnap.exists()) {
                const authorData = userSnap.val();
                authorHasBadge = authorData.badgeInfo && authorData.badgeInfo.expiryTimestamp && authorData.badgeInfo.expiryTimestamp > Date.now();
            }
            
            const postContainer = document.createElement('div');
            postContainer.id = `post-${postId}`;
            postContainer.dataset.postId = postId; 
            
            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            const time = new Date(postData.timestamp).toLocaleString();
            
            const isMyPost = postData.authorUid === currentUser.uid;
            
            let actionButtons = `<button class="post-action-btn" id="like-btn-${postId}" onclick="handleReaction('${postId}', '${postData.authorUid}')"><svg viewBox="0 0 24 24"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.91l-.01-.01L23 10z"></path></svg><span id="like-text-${postId}">Like</span><span id="like-count-${postId}" style="margin-left: 4px; font-weight: normal;"></span></button>`;
            actionButtons += `<button class="post-action-btn" onclick="toggleComments('${postId}', '${postData.authorUid}')"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"></path></svg><span>Comment</span><span id="comment-count-${postId}" style="margin-left: 4px; font-weight: normal;"></span></button>`;
            if (!isMyPost) {
                actionButtons += `<button class="post-action-btn" onclick="initiateDmFromPost('${postData.authorUid}')"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"></path></svg><span>Message</span></button>`;
            } else {
                 actionButtons += `<button class="post-action-btn" onclick="openBoostModal('${postId}')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2z"></path></svg><span>Boost Now</span></button>`;
            }

            const isBoosted = postData.boostInfo && postData.boostInfo.status === 'active' && postData.boostInfo.endDate > Date.now();
            const sponsoredLabelHtml = isBoosted ? `<div class="sponsored-label">Sponsored</div>` : '';
            
            let boostButtonHtml = '';
            if (isBoosted && postData.boostInfo.buttonType && postData.boostInfo.buttonType !== 'none' && postData.boostInfo.buttonLink) {
                const buttonText = postData.boostInfo.buttonType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                boostButtonHtml = `<a onclick="handleBoostClick('${postId}', '${escapeHTML(postData.boostInfo.buttonLink)}')" class="boost-cta-button">${escapeHTML(buttonText)}</a>`;
            }

            let postContentHtml = '';
            if (postData.imageUrl) { postContentHtml += `<img src="${postData.imageUrl}" alt="Post image" class="post-image" onclick="viewPostImage('${postData.imageUrl}')">`; }
            
            if (postData.text) { 
                postContentHtml += `<div class="post-text-content" style="${postData.imageUrl ? 'margin-top:10px;' : ''}">${linkify(postData.text)}</div>`;
            }
            
            if (postData.hasVideo && postData.googleDriveId) {
                const defaultThumbnail = `https://via.placeholder.com/480x360.png?text=${encodeURIComponent(postData.text || 'Video')}`;
                const thumbnailUrl = postData.videoThumbnailUrl || defaultThumbnail;
                
                postContentHtml += `
                    <div id="vid-container-${postId}" class="video-thumbnail-container" onclick="playGoogleDriveVideo('${postId}', '${postData.googleDriveId}')">
                        <img src="${thumbnailUrl}" alt="Video thumbnail">
                        <div class="play-button-overlay">
                            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        </div>
                    </div>`;
            }

            postContentHtml += boostButtonHtml; 

            const postMenuId = `post-menu-${postId}`;
            const postMenu = `<div style="position: relative;"><button class="icon-btn post-menu-btn" onclick="togglePostMenu(event, '${postMenuId}')"><svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg></button><div id="${postMenuId}" class="post-dropdown-menu">${isMyPost ? `<button onclick="openEditModal('${postId}')">Edit Post</button>` : ''}${postData.imageUrl ? `<button onclick="savePostImage('${postData.imageUrl}')">Save Image</button>` : ''}<button onclick="sharePost('${postId}')">Share</button>${isMyPost ? `<button style="color: #d93025;" onclick="deletePost('${postId}')">Delete Post</button>` : `<button onclick="reportPost('${postId}', '${postData.authorUid}')">Report</button>`}</div></div>`;
            
            postCard.innerHTML = `<div class="post-header"><img src="${postData.authorProfileImageUrl}" alt="${postData.authorName}" class="post-author-img" onclick="showView('user-profile-view'); openUserProfileView('${postData.authorUid}')"><div class="post-author-info"><div class="name" onclick="showView('user-profile-view'); openUserProfileView('${postData.authorUid}')">${escapeHTML(postData.authorName)} ${authorHasBadge ? getBlueBadgeIcon(true) : ''}</div>${sponsoredLabelHtml}<div class="timestamp">${time}</div></div>${postMenu}</div><div class="post-content">${postContentHtml}</div><div class="post-actions">${actionButtons}</div>`;
            const commentsSection = document.createElement('div');
            commentsSection.className = 'post-comments-section';
            commentsSection.id = `comments-for-${postId}`;
            commentsSection.style.display = 'none';

            postContainer.appendChild(postCard);
            postContainer.appendChild(commentsSection);

            if (replaceElement) {
                if (postIntersectionObserver) postIntersectionObserver.unobserve(replaceElement);
                containerElement.replaceChild(postContainer, replaceElement);
            } else if (prepend) {
                containerElement.prepend(postContainer);
            } else {
                containerElement.appendChild(postContainer);
            }

            if (isBoosted && postIntersectionObserver) {
                postIntersectionObserver.observe(postContainer);
            }

            db.ref(`posts/${postId}/reactions/like`).on('value', likeSnapshot => {
                const count = likeSnapshot.numChildren();
                const likeButton = document.getElementById(`like-btn-${postId}`);
                const countSpan = document.getElementById(`like-count-${postId}`);
                const likeTextSpan = document.getElementById(`like-text-${postId}`);
                if(countSpan) { countSpan.textContent = count > 0 ? formatNumber(count) : ''; }
                if (likeButton) { if (likeSnapshot.hasChild(currentUser.uid)) { likeButton.classList.add('liked'); if (likeTextSpan) likeTextSpan.textContent = 'Liked'; } else { likeButton.classList.remove('liked'); if (likeTextSpan) likeTextSpan.textContent = 'Like'; } }
            });

            db.ref(`posts/${postId}/comments`).on('value', commentSnapshot => {
                const count = commentSnapshot.numChildren();
                const countSpan = document.getElementById(`comment-count-${postId}`);
                if (countSpan) { countSpan.textContent = count > 0 ? formatNumber(count) : ''; }
            });
        }
        
        window.playGoogleDriveVideo = (postId, driveId) => {
            const container = document.getElementById(`vid-container-${postId}`);
            if(container) {
                const embedUrl = `https://drive.google.com/file/d/${driveId}/preview`;
                container.outerHTML = `<div class="video-container"><iframe src="${embedUrl}" allow="fullscreen" allowfullscreen></iframe></div>`;
            }
        };

        async function initiateDmFromPost(authorUid) {
            const userSnap = await db.ref(`users/${authorUid}`).once('value');
            if(userSnap.exists()){
                const userData = userSnap.val();
                openDmChat(authorUid, userData);
            }
        }

        window.togglePostMenu = (event, menuId) => { event.stopPropagation(); const menu = document.getElementById(menuId); const isVisible = menu.style.display === 'block'; document.querySelectorAll('.post-dropdown-menu').forEach(m => m.style.display = 'none'); if (menu) menu.style.display = isVisible ? 'none' : 'block'; };
        window.viewPostImage = (imageUrl) => { document.getElementById('post-image-view-src').src = imageUrl; showModal('post-image-view-modal'); };
        window.sharePost = (postId) => {
            const postUrl = `${window.location.origin}${window.location.pathname}#post?id=${postId}`;
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this post on Mygram',
                    text: 'I found this interesting post!',
                    url: postUrl,
                });
            } else {
                navigator.clipboard.writeText(postUrl).then(() => alert('Post link copied to clipboard!'), () => alert('Failed to copy link.'));
            }
        };

        window.reportPost = (postId) => { if(confirm("Report this post?")) alert("Post reported."); };
        function createNotification(targetUid, type, text, postId) { if (targetUid === currentUser.uid && type !== 'boost_approved' && type !== 'request_rejected' && type !== 'badge_approved' && type !== 'badge_expiring' && type !== 'boost_expiring' && type !== 'welcome_bonus') return; db.ref(`notifications/${targetUid}`).push().set({ fromUserId: currentUser.uid, fromUserName: currentUser.name, fromUserImage: currentUser.profileImageUrl, type: type, text: text, postId: postId, timestamp: firebase.database.ServerValue.TIMESTAMP, read: false }); }
        
        window.handleReaction = (postId, postAuthorUid) => {
            const reactionRef = db.ref(`posts/${postId}/reactions/like/${currentUser.uid}`);
            
            reactionRef.once('value', snapshot => {
                if (snapshot.exists()) {
                    reactionRef.remove();
                } else {
                    reactionRef.set(true);
                    createNotification(postAuthorUid, 'like', 'liked your post.', postId);
                }
            });
        };
        
        window.toggleComments = (postId, postAuthorUid) => { const commentsSection = document.getElementById(`comments-for-${postId}`); if (commentsSection.style.display === 'none') { commentsSection.style.display = 'block'; renderComments(postId, postAuthorUid); } else { commentsSection.style.display = 'none'; commentsSection.innerHTML = ''; } };
        async function renderComments(postId, postAuthorUid) { const commentsSection = document.getElementById(`comments-for-${postId}`); commentsSection.innerHTML = `<div style="display:flex; gap:10px; margin-top:15px;"><input type="text" id="comment-input-${postId}" placeholder="Write a comment..." style="flex-grow:1; border: 1px solid #ccc; border-radius:15px; padding: 8px 12px; font-size:14px;"><button onclick="addComment('${postId}', '${postAuthorUid}')" style="border:none; background:none; color: var(--wa-header-bg); font-weight:500; cursor:pointer;">Post</button></div><div id="comment-list-${postId}"></div>`; db.ref(`posts/${postId}/comments`).on('child_added', snapshot => { const commentData = snapshot.val(), commentId = snapshot.key; const commentDiv = document.createElement('div'); commentDiv.className = 'comment-item'; commentDiv.id = `comment-${commentId}`; let deleteBtn = (commentData.authorUid === currentUser.uid) ? `<span class="comment-delete-btn" onclick="deleteComment('${postId}', '${commentId}')">Delete</span>` : ''; commentDiv.innerHTML = `<img src="${commentData.authorProfileImageUrl}" alt="${commentData.authorName}" class="comment-author-img"><div class="comment-content">${deleteBtn}<div class="comment-author-name">${escapeHTML(commentData.authorName)}</div><div>${linkify(commentData.text)}</div></div>`; document.getElementById(`comment-list-${postId}`).prepend(commentDiv); }); }
        window.deleteComment = (postId, commentId) => { if (confirm("Delete this comment?")) { db.ref(`posts/${postId}/comments/${commentId}`).remove(); } };
        window.addComment = (postId, postAuthorUid) => { const input = document.getElementById(`comment-input-${postId}`); const text = input.value.trim(); if(!text) return; const commentData = { authorUid: currentUser.uid, authorName: currentUser.name, authorProfileImageUrl: currentUser.profileImageUrl, text: text, timestamp: firebase.database.ServerValue.TIMESTAMP }; db.ref(`posts/${postId}/comments`).push(commentData).then(() => { input.value = ''; createNotification(postAuthorUid, 'comment', `commented: ${text.substring(0, 20)}...`, postId); }); };
        
        function goToPost(postId) {
             setTimeout(() => {
                const postElement = document.getElementById(`post-${postId}`);
                if (postElement) {
                    postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    postElement.querySelector('.post-card').classList.add('highlight');
                    setTimeout(() => postElement.querySelector('.post-card').classList.remove('highlight'), 2000);
                } else {
                    alert("Post not found. It may have been deleted or is not visible to you.");
                }
            }, 500); // Delay to ensure posts are rendered
        }

        window.goToPostFromNotification = (postId, notificationId, event) => {
            if (event && event.currentTarget) event.currentTarget.classList.remove('unread');
            db.ref(`notifications/${currentUser.uid}/${notificationId}`).update({ read: true });
            if (!postId) return;
            showView('main-view'); showPanel('posts-content');
            goToPost(postId);
        };
        
        document.getElementById('view-my-posts-btn').addEventListener('click', () => { showView('my-posts-view'); showMyPostsView(); });
        
        function showMyPostsView() { 
            const list = document.getElementById('my-posts-list'); 
            list.innerHTML = 'Loading...'; 
            db.ref('posts').orderByChild('authorUid').equalTo(currentUser.uid).once('value', snapshot => { 
                list.innerHTML = ''; 
                if (!snapshot.exists()) { 
                    list.innerHTML = '<p style="text-align:center; padding: 40px;">You have no posts yet.</p>'; 
                    return; 
                } 
                let posts = []; 
                snapshot.forEach(child => {
                    posts.push({ id: child.key, ...child.val() });
                }); 
                posts.reverse().forEach(post => { 
                    if(post.hasVideo) return; // Do not show video posts here
                    const postDiv = document.createElement('div');
                    postDiv.className = 'post-card';
                    const time = new Date(post.timestamp).toLocaleString(); 
                    let content = post.text ? `<div class="post-content">${linkify(post.text)}</div>` : ''; 
                    if (post.imageUrl) content += `<img src="${post.imageUrl}" class="post-image" onclick="viewPostImage('${post.imageUrl}')">`;
                    postDiv.innerHTML = `<div class="post-header"><img src="${post.authorProfileImageUrl}" class="list-item-profile-img" style="width:40px;height:40px;"><div class="post-author-info"><div class="name">${escapeHTML(post.authorName)}</div><div class="timestamp">${time}</div></div><div class="post-controls"><span class="edit-post-btn post-control-btn" onclick="openEditModal('${post.id}')">Edit</span><span class="delete-post-btn post-control-btn" onclick="deletePost('${post.id}')">Delete</span></div></div>${content}`; 
                    list.appendChild(postDiv); 
                }); 
            }); 
        }

        window.deletePost = (postId) => { if (confirm("Delete this post?")) { db.ref(`posts/${postId}`).remove().then(() => { if (currentView === 'my-posts-view') showMyPostsView(); if (currentView === 'user-all-posts-view') goBack(); }); } };
        
        async function openUserProfileView(userId) { 
            const userSnap = await db.ref(`users/${userId}`).once('value'); 
            if (!userSnap.exists()) return; 
            const userData = userSnap.val(); 
            const userHasActiveBadge = userData.badgeInfo && userData.badgeInfo.expiryTimestamp > Date.now(); 
            document.getElementById('user-profile-page-title').textContent = userData.name; 
            const infoDisplay = document.getElementById('user-profile-info-display'); 
            infoDisplay.querySelector('.profile-cover-photo').src = userData.coverImageUrl || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; 
            infoDisplay.querySelector('.profile-img').src = userData.profileImageUrl; 
            infoDisplay.querySelector('.name').innerHTML = `${escapeHTML(userData.name)} ${getBlueBadgeIcon(userHasActiveBadge)}`; 
            document.getElementById('user-profile-friends-count').textContent = formatNumber(Object.keys(userData.contacts || {}).length); 
            document.getElementById('user-profile-followers-count').textContent = formatNumber(Object.keys(userData.followers || {}).length); 
            document.getElementById('user-profile-likes-count').textContent = '...'; 
            calculateTotalLikes(userId).then(totalLikes => { document.getElementById('user-profile-likes-count').textContent = formatNumber(totalLikes); }); 
            
            const followBtn = document.getElementById('follow-user-btn');
            const friendBtn = document.getElementById('user-profile-friend-btn');
            const blockBtn = document.getElementById('user-profile-block-btn');
            
            if (userId === currentUser.uid) {
                showView('profile-view');
                return;
            } else {
                 document.getElementById('user-profile-actions').style.display = 'flex';
            }
            
            const isFollowing = currentUser.following && currentUser.following[userId]; 
            followBtn.innerHTML = `<span>${isFollowing ? `Following` : `Follow`}</span>`;
            followBtn.onclick = () => toggleFollow(userId); 

            friendBtn.disabled = false;
            const isFriend = currentUser.contacts && currentUser.contacts[userId];
            if (isFriend) {
                friendBtn.innerHTML = `<span>Message</span>`;
                friendBtn.onclick = () => openDmChat(userId, userData);
            } else {
                const sentRequestSnap = await db.ref(`requests/${userId}/${currentUser.uid}`).once('value');
                const receivedRequestSnap = await db.ref(`requests/${currentUser.uid}/${userId}`).once('value');

                if (sentRequestSnap.exists()) {
                    friendBtn.innerHTML = `<span>Request Sent</span>`;
                    friendBtn.onclick = () => cancelFriendRequest(userId); 
                } else if (receivedRequestSnap.exists() && receivedRequestSnap.val().type === 'incoming') {
                    friendBtn.innerHTML = `<span>Respond to Request</span>`;
                    friendBtn.onclick = () => showView('notifications-view');
                }
                else {
                    friendBtn.innerHTML = `<span>Add Friend</span>`;
                    friendBtn.onclick = () => sendFriendRequestFromProfile(userId);
                }
            }

            const isBlocked = currentUser.blocked && currentUser.blocked[userId];
            blockBtn.innerHTML = isBlocked ? `<span>Unblock User</span>` : `<span>Block User</span>`;
            blockBtn.onclick = () => toggleBlockUser(userId, userData.name);
            
            document.getElementById('user-profile-show-qr-btn').onclick = () => { const qrDisplay = document.getElementById('qr-code-display'); qrDisplay.innerHTML = ''; new QRCode(qrDisplay, { text: userData.jgId, width: 200, height: 200 }); document.getElementById('qr-code-text').textContent = userData.jgId; showModal('qr-code-modal'); }; 
            
            const postsList = document.getElementById('user-profile-posts-list'); 
            postsList.innerHTML = 'Loading posts...'; 
            db.ref('posts').orderByChild('authorUid').equalTo(userId).limitToLast(3).once('value', snapshot => { 
                postsList.innerHTML = ''; 
                if (!snapshot.exists()) { 
                    postsList.innerHTML = '<p style="text-align:center; padding: 20px;">No posts yet.</p>'; 
                    return; 
                } 
                let userPosts = []; 
                snapshot.forEach(child => userPosts.push(child)); 
                userPosts.reverse().forEach(postSnap => {
                    const userProfilePostContainer = document.getElementById('user-profile-posts-list');
                    renderSinglePost(postSnap, userProfilePostContainer, false);
                });
            }); 
        }

        function toggleFollow(userIdToFollow) { const followingRef = db.ref(`users/${currentUser.uid}/following/${userIdToFollow}`); const followerRef = db.ref(`users/${userIdToFollow}/followers/${currentUser.uid}`); followingRef.once('value', snapshot => { if (snapshot.exists()) { followingRef.remove(); followerRef.remove(); } else { followingRef.set(true); followerRef.set(true); } openUserProfileView(userIdToFollow); }); }
        
        function sendFriendRequestFromProfile(friendUid) { db.ref(`users/${friendUid}`).once('value', friendSnap => { const friendData = friendSnap.val(); const request = { name: currentUser.name, profileImageUrl: currentUser.profileImageUrl, type: 'incoming' }; db.ref(`requests/${friendUid}/${currentUser.uid}`).set(request).then(() => { alert('Friend request sent!'); openUserProfileView(friendUid); }); }); }
        function unfriendUser(friendUid) { if(confirm("Are you sure you want to remove this friend?")){ db.ref(`users/${currentUser.uid}/contacts/${friendUid}`).remove(); db.ref(`users/${friendUid}/contacts/${currentUser.uid}`).remove(); alert("Friend removed."); openUserProfileView(friendUid); } }
        function cancelFriendRequest(friendUid) { if(confirm("Are you sure you want to cancel this friend request?")){ db.ref(`requests/${friendUid}/${currentUser.uid}`).remove(); alert("Friend request cancelled."); openUserProfileView(friendUid); } }
        function toggleBlockUser(userId, userName) { const isBlocked = currentUser.blocked && currentUser.blocked[userId]; if(isBlocked) { db.ref(`users/${currentUser.uid}/blocked/${userId}`).remove().then(() => { alert(`${userName} has been unblocked.`); openUserProfileView(userId); }); } else { if(confirm(`Are you sure you want to block ${userName}? You won't see their posts or receive requests from them.`)){ db.ref(`users/${currentUser.uid}/blocked/${userId}`).set(true).then(() => { db.ref(`users/${currentUser.uid}/contacts/${userId}`).remove(); db.ref(`users/${userId}/contacts/${currentUser.uid}`).remove(); alert(`${userName} has been blocked.`); openUserProfileView(userId); }); } } }

        // --- PAYMENT, BOOST AND EDIT FUNCTIONS ---
        async function deductFunds(totalCost, reason) {
            const updates = {};
            let remainingCost = totalCost;
            const wallet = currentUser.wallet || { coupon: 0, refer: 0, main: 0 };
            const totalAvailable = (wallet.coupon || 0) + (wallet.refer || 0) + (wallet.main || 0);
            if (totalAvailable < totalCost) {
                return { success: false, message: `Insufficient balance. You need $${totalCost.toFixed(2)} but you only have $${totalAvailable.toFixed(2)}.` };
            }

            if (remainingCost > 0 && wallet.coupon > 0) {
                const deductFromCoupon = Math.min(remainingCost, wallet.coupon);
                updates[`users/${currentUser.uid}/wallet/coupon`] = firebase.database.ServerValue.increment(-deductFromCoupon);
                const couponTxKey = db.ref(`transactionHistory/${currentUser.uid}`).push().key;
                updates[`transactionHistory/${currentUser.uid}/${couponTxKey}`] = { amount: -deductFromCoupon, reason: `${reason} (from Coupon)`, timestamp: firebase.database.ServerValue.TIMESTAMP };
                remainingCost -= deductFromCoupon;
            }

            if (remainingCost > 0 && wallet.refer > 0) {
                const deductFromRefer = Math.min(remainingCost, wallet.refer);
                updates[`users/${currentUser.uid}/wallet/refer`] = firebase.database.ServerValue.increment(-deductFromRefer);
                const referTxKey = db.ref(`transactionHistory/${currentUser.uid}`).push().key;
                updates[`transactionHistory/${currentUser.uid}/${referTxKey}`] = { amount: -deductFromRefer, reason: `${reason} (from Refer)`, timestamp: firebase.database.ServerValue.TIMESTAMP };
                remainingCost -= deductFromRefer;
            }

            if (remainingCost > 0) {
                updates[`users/${currentUser.uid}/wallet/main`] = firebase.database.ServerValue.increment(-remainingCost);
                const mainTxKey = db.ref(`transactionHistory/${currentUser.uid}`).push().key;
                updates[`transactionHistory/${currentUser.uid}/${mainTxKey}`] = { amount: -remainingCost, reason: `${reason} (from Main)`, timestamp: firebase.database.ServerValue.TIMESTAMP };
            }

            return { success: true, updates };
        }
        
        function listenForAdminActions() {
            // Boost Requests
            db.ref('boostRequests').orderByChild('userId').equalTo(currentUser.uid).on('child_changed', async (snapshot) => {
                const request = { id: snapshot.key, ...snapshot.val() };
                if (request.status === 'approved' && !request.notificationSent) { 
                    createNotification(currentUser.uid, 'boost_approved', 'Your post boost has been approved!', request.postId); 
                    notificationSound.play().catch(e => {});
                    db.ref(`boostRequests/${request.id}/notificationSent`).set(true); 
                }
                if (request.status === 'rejected' && !request.refunded) {
                    const updates = {};
                    updates[`users/${currentUser.uid}/wallet/main`] = firebase.database.ServerValue.increment(request.cost);
                    updates[`boostRequests/${request.id}/refunded`] = true;
                    const txKey = db.ref(`transactionHistory/${currentUser.uid}`).push().key;
                    updates[`transactionHistory/${currentUser.uid}/${txKey}`] = { amount: request.cost, reason: `Refund for rejected boost`, timestamp: firebase.database.ServerValue.TIMESTAMP };
                    await db.ref().update(updates);
                    createNotification(currentUser.uid, 'request_rejected', `Your boost request was rejected. $${request.cost.toFixed(2)} refunded.`, request.postId);
                    notificationSound.play().catch(e => {});
                }
            });
            // Badge Requests
            db.ref('badgeRequests').orderByChild('userId').equalTo(currentUser.uid).on('child_changed', async (snapshot) => {
                const request = { id: snapshot.key, ...snapshot.val() };
                 if (request.status === 'approved' && !request.notificationSent) {
                     createNotification(currentUser.uid, 'badge_approved', `Your ${request.packageName} has been activated!`, null);
                     notificationSound.play().catch(e => {});
                     db.ref(`badgeRequests/${request.id}/notificationSent`).set(true);
                 }
                 if (request.status === 'rejected' && !request.refunded) {
                    const updates = {};
                    updates[`users/${currentUser.uid}/wallet/main`] = firebase.database.ServerValue.increment(request.costUSD);
                    updates[`badgeRequests/${request.id}/refunded`] = true;
                    const txKey = db.ref(`transactionHistory/${currentUser.uid}`).push().key;
                    updates[`transactionHistory/${currentUser.uid}/${txKey}`] = { amount: request.costUSD, reason: `Refund for rejected badge request`, timestamp: firebase.database.ServerValue.TIMESTAMP };
                    await db.ref().update(updates);
                    createNotification(currentUser.uid, 'request_rejected', `Your badge request was rejected. $${request.costUSD.toFixed(2)} refunded.`, null);
                    notificationSound.play().catch(e => {});
                 }
            });
        }

        function checkExpiries() {
            if (currentUser.badgeInfo && currentUser.badgeInfo.expiryTimestamp) {
                const timeLeft = currentUser.badgeInfo.expiryTimestamp - Date.now();
                const threeDays = 3 * 24 * 60 * 60 * 1000;
                if (timeLeft > 0 && timeLeft < threeDays) {
                    const notifKey = `badge_expiry_${currentUser.badgeInfo.expiryTimestamp}`;
                    if (!localStorage.getItem(notifKey)) {
                        createNotification(currentUser.uid, 'badge_expiring', 'Your Blue Badge is expiring soon!', null);
                        localStorage.setItem(notifKey, 'true');
                    }
                }
            }
            db.ref('boostRequests').orderByChild('userId').equalTo(currentUser.uid).once('value', snapshot => {
                if(snapshot.exists()){
                    snapshot.forEach(child => {
                        const boost = child.val();
                        if(boost.status === 'active' && boost.endDate){
                            const timeLeft = boost.endDate - Date.now();
                            const oneDay = 24 * 60 * 60 * 1000;
                            if(timeLeft > 0 && timeLeft < oneDay) {
                                const notifKey = `boost_expiry_${child.key}`;
                                if(!localStorage.getItem(notifKey)) {
                                    createNotification(currentUser.uid, 'boost_expiring', 'One of your post boosts is ending soon.', boost.postId);
                                    localStorage.setItem(notifKey, 'true');
                                }
                            }
                        }
                    });
                }
            });
        }

        function openBoostModal(postId) {
            document.getElementById('boost-days-input').value = 1;
            document.getElementById('boost-button-type-select').value = 'none';
            document.getElementById('boost-button-link-input').value = '';
            document.getElementById('boost-link-container').style.display = 'none';
            document.getElementById('confirm-boost-btn').dataset.postId = postId;
            updateBoostCost();
            showModal('boost-post-modal');
        }

        function updateBoostCost() {
            const days = parseInt(document.getElementById('boost-days-input').value) || 0;
            const totalCost = (days * boostCostPerDay).toFixed(2);
            document.getElementById('boost-total-cost').textContent = totalCost;
        }

        document.getElementById('boost-days-input').addEventListener('input', updateBoostCost);
        document.getElementById('boost-button-type-select').addEventListener('change', (e) => {
            const linkContainer = document.getElementById('boost-link-container');
            if (e.target.value === 'none') {
                linkContainer.style.display = 'none';
            } else {
                linkContainer.style.display = 'flex';
            }
        });
        
        document.getElementById('close-boost-modal-btn').addEventListener('click', () => showModal('boost-post-modal', false));

        document.getElementById('confirm-boost-btn').addEventListener('click', async (e) => {
            const postId = e.target.dataset.postId;
            const days = parseInt(document.getElementById('boost-days-input').value);
            const buttonType = document.getElementById('boost-button-type-select').value;
            const buttonLink = document.getElementById('boost-button-link-input').value.trim();
            const totalCost = days * boostCostPerDay;

            if (isNaN(days) || days < 1) return alert('Please enter a valid number of days.');
            if (buttonType !== 'none' && !buttonLink) return alert('Please provide a link for the button.');

            const paymentResult = await deductFunds(totalCost, `Post Boost (${days} days)`);
            if (!paymentResult.success) {
                alert(paymentResult.message);
                return;
            }

            try {
                const updates = paymentResult.updates;
                const newRequestKey = db.ref('boostRequests').push().key;
                updates[`boostRequests/${newRequestKey}`] = {
                    userId: currentUser.uid,
                    postId: postId,
                    durationDays: days,
                    cost: totalCost,
                    buttonType: buttonType,
                    buttonLink: buttonLink,
                    status: 'pending',
                    requestedAt: firebase.database.ServerValue.TIMESTAMP
                };

                await db.ref().update(updates);
                alert('Boost request sent for approval!');
                showModal('boost-post-modal', false);

            } catch (error) {
                alert("Could not send boost request. Please try again.");
                console.error("Boost failed:", error);
            }
        });

        async function openEditModal(postId) { 
            const postSnap = await db.ref(`posts/${postId}`).once('value'); 
            if(postSnap.exists()){ 
                document.getElementById('edit-post-textarea').value = postSnap.val().text || ''; 
                document.getElementById('save-edit-post-btn').dataset.postId = postId; 
                showModal('edit-post-modal'); 
            } 
        }

        document.getElementById('close-edit-modal-btn').addEventListener('click', () => showModal('edit-post-modal', false));
        
        document.getElementById('save-edit-post-btn').addEventListener('click', (e) => { 
            const postId = e.target.dataset.postId; 
            const newText = document.getElementById('edit-post-textarea').value.trim(); 
            db.ref(`posts/${postId}`).update({ text: newText }).then(() => { 
                alert('Post updated!'); 
                showModal('edit-post-modal', false); 
            }); 
        });

        document.getElementById('add-money-btn').addEventListener('click', () => {
            const msgDiv = document.getElementById('redeem-message');
            msgDiv.textContent = '';
            msgDiv.style.color = '#d93025';
            document.getElementById('redeem-code-input').value = '';
            showModal('add-money-modal');
        });

        document.getElementById('close-add-money-modal-btn').addEventListener('click', () => {
            showModal('add-money-modal', false);
        });

        document.getElementById('confirm-redeem-btn').addEventListener('click', async () => {
            const codeInput = document.getElementById('redeem-code-input').value.trim();
            const selectedBalanceType = document.getElementById('balance-type-select').value;
            const messageDiv = document.getElementById('redeem-message');
            
            if (!codeInput) { messageDiv.textContent = 'Please enter a redeem code.'; return; }

            const redeemCodeRef = db.ref(`redeemCodes/${codeInput}`);
            const snapshot = await redeemCodeRef.once('value');

            if (!snapshot.exists()) { messageDiv.textContent = 'Invalid redeem code.'; return; }

            const codeData = snapshot.val();

            if (codeData.usedBy) { messageDiv.textContent = 'This code has already been used.'; return; }

            if (codeData.expiryTimestamp && codeData.expiryTimestamp < Date.now()) { messageDiv.textContent = 'This code has expired.'; return; }
            
            if (codeData.balanceType !== selectedBalanceType) { messageDiv.textContent = `This code is for "${codeData.balanceType}" balance, not "${selectedBalanceType}".`; return; }

            try {
                const amount = parseFloat(codeData.amount);
                const updates = {};
                updates[`users/${currentUser.uid}/wallet/${selectedBalanceType}`] = firebase.database.ServerValue.increment(amount);
                updates[`redeemCodes/${codeInput}/usedBy`] = currentUser.uid;
                updates[`redeemCodes/${codeInput}/usedAt`] = firebase.database.ServerValue.TIMESTAMP;
                const newTransactionKey = db.ref(`transactionHistory/${currentUser.uid}`).push().key;
                updates[`transactionHistory/${currentUser.uid}/${newTransactionKey}`] = { amount: amount, reason: `Redeemed code: ${codeInput}`, timestamp: firebase.database.ServerValue.TIMESTAMP };
                await db.ref().update(updates);
                messageDiv.style.color = 'green';
                messageDiv.textContent = `Successfully added $${amount.toFixed(2)} to your ${selectedBalanceType} balance!`;
                document.getElementById('redeem-code-input').value = '';
            } catch (error) {
                messageDiv.textContent = 'An error occurred. Please try again.';
                console.error("Redeem failed: ", error);
            }
        });

        async function renderBoostDashboard() {
            const listContainer = document.getElementById('boost-dashboard-list');
            listContainer.innerHTML = '<p>Loading boosted posts...</p>';
            const boostRequestsRef = db.ref('boostRequests').orderByChild('userId').equalTo(currentUser.uid);
            boostRequestsRef.on('value', async (snapshot) => {
                if (!snapshot.exists()) {
                    listContainer.innerHTML = '<p style="text-align:center; color: #667781; padding: 20px;">You have no boosted posts.</p>';
                    return;
                }

                listContainer.innerHTML = '';
                let requests = [];
                snapshot.forEach(child => { requests.push({ id: child.key, ...child.val() }); });
                requests.reverse();

                for (const req of requests) {
                    const postSnap = await db.ref(`posts/${req.postId}`).once('value');
                    if (!postSnap.exists()) continue;
                    
                    const post = postSnap.val();
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'boost-dashboard-item';

                    let statusText = req.status.charAt(0).toUpperCase() + req.status.slice(1);
                    let statusClass = req.status;
                    if (req.status === 'approved') {
                        if (req.endDate < Date.now()) { statusText = 'Ended'; statusClass = 'ended'; } else { statusText = 'Active'; statusClass = 'active'; }
                    }
                    
                    const postImage = post.imageUrl || post.authorProfileImageUrl;
                    const postText = post.text ? escapeHTML(post.text) : 'Image Post';
                    const viewCount = post.boostViews ? Object.keys(post.boostViews).length : 0;
                    const clickCount = post.boostClicks ? Object.keys(post.boostClicks).length : 0;
                    const likeCount = post.reactions && post.reactions.like ? Object.keys(post.reactions.like).length : 0;
                    const startDate = req.startDate ? new Date(req.startDate).toLocaleDateString() : 'N/A';
                    const endDate = req.endDate ? new Date(req.endDate).toLocaleDateString() : 'N/A';

                    itemDiv.innerHTML = `<div class="boost-item-header"><img src="${postImage}" alt="Post thumbnail"><div class="boost-item-details"><p>${postText}</p><span class="boost-status ${statusClass}">${statusText}</span></div></div><div class="boost-item-stats"><div class="boost-stat"><span>${formatNumber(viewCount)}</span> Views</div><div class="boost-stat"><span>${formatNumber(clickCount)}</span> Clicks</div><div class="boost-stat"><span>${formatNumber(likeCount)}</span> Likes</div></div><div class="boost-item-footer"><span>Duration: ${startDate} to ${endDate}</span></div>`;
                    listContainer.appendChild(itemDiv);
                }
            });
        }

        function setupIntersectionObserver() {
            const options = { root: document.getElementById('main-content'), rootMargin: '0px', threshold: 0.5 };
            postIntersectionObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const postId = entry.target.dataset.postId;
                        if (postId) {
                            db.ref(`posts/${postId}/boostViews/${currentUser.uid}`).set(true);
                            observer.unobserve(entry.target);
                        }
                    }
                });
            }, options);
        }

        window.handleBoostClick = (postId, link) => {
            db.ref(`posts/${postId}/boostClicks/${currentUser.uid}`).set(true);
            window.open(link, '_blank');
        };

        // --- SEARCH FUNCTIONALITY ---
        function setupSearch() {
            document.getElementById('search-user-btn').addEventListener('click', () => {
                const searchContainer = document.getElementById('search-container');
                const searchResultsContainer = document.getElementById('search-results-container');
                const isVisible = searchContainer.style.display === 'block';
                searchContainer.style.display = isVisible ? 'none' : 'block';
                if (isVisible) {
                    searchResultsContainer.style.display = 'none';
                    document.getElementById('search-input').value = '';
                } else {
                    document.getElementById('search-input').focus();
                }
            });

            document.getElementById('search-input').addEventListener('keyup', handleSearch);
        }

        async function handleSearch(e) {
            const query = e.target.value.toLowerCase().trim();
            const resultsContainer = document.getElementById('search-results-container');

            if (!query) {
                resultsContainer.innerHTML = '';
                resultsContainer.style.display = 'none';
                return;
            }
            if (query.startsWith('#')) {
                resultsContainer.innerHTML = `<p style="text-align:center; color: #667781; padding: 20px;">Searching for posts with ${query}...</p>`;
                resultsContainer.style.display = 'block';

                const postsRef = db.ref('posts').orderByChild('timestamp').limitToLast(100);
                const snapshot = await postsRef.once('value');
                resultsContainer.innerHTML = '';
                let found = false;
                if(snapshot.exists()) {
                    snapshot.forEach(child => {
                        const post = child.val();
                        if (post.text && post.text.toLowerCase().includes(query)) {
                            renderSinglePost(child, resultsContainer, false);
                            found = true;
                        }
                    });
                }
                if (!found) {
                     resultsContainer.innerHTML = `<p style="text-align:center; color: #667781; padding: 20px;">No posts found with the tag ${query}.</p>`;
                }
                return;
            }

            if (allUsersCache.length === 0) {
                const usersSnap = await db.ref('users').once('value');
                if (usersSnap.exists()) {
                    usersSnap.forEach(child => {
                        allUsersCache.push({ uid: child.key, ...child.val() });
                    });
                }
            }
            
            const results = allUsersCache.filter(user => 
                (user.name && user.name.toLowerCase().includes(query)) || 
                (user.jgId && user.jgId.toLowerCase() === query)
            );

            renderSearchResults(results, resultsContainer);
        }

        function renderSearchResults(results, container) {
            container.innerHTML = '';
            if (results.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: #667781; padding: 20px;">No users found.</p>';
            } else {
                results.slice(0, 20).forEach(user => { 
                    if (user.uid === currentUser.uid) return;
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.onclick = () => {
                        showView('user-profile-view');
                        openUserProfileView(user.uid);
                        document.getElementById('search-container').style.display = 'none';
                        container.style.display = 'none';
                        document.getElementById('search-input').value = '';
                    };
                    div.innerHTML = `<img src="${user.profileImageUrl}" class="list-item-profile-img" alt="P"><div class="list-item-details"><div class="list-item-name">${escapeHTML(user.name)}</div><div class="list-item-subtext">${user.jgId}</div></div>`;
                    container.appendChild(div);
                });
            }
            container.style.display = 'block';
        }
        
        // --- SETTINGS VIEW ---
        async function openSettingsView() {
            document.getElementById('settings-current-email').textContent = currentUser.email;
            document.getElementById('change-dob-item').style.opacity = currentUser.dobChanged ? '0.5' : '1';
            document.getElementById('change-gender-item').style.opacity = currentUser.genderChanged ? '0.5' : '1';
            renderBlockedUsers();
            
            const usersRef = db.ref('users');
            const snapshot = await usersRef.orderByChild('referredBy').equalTo(currentUser.uid).once('value');
            document.getElementById('total-referrals-count').textContent = snapshot.numChildren();
        }

        function setupSettingsListeners() {
            document.getElementById('profile-settings-btn').addEventListener('click', () => showView('settings-view'));

            document.getElementById('change-email-item').addEventListener('click', () => {
                alert("For security reasons, email cannot be changed after verification.");
            });

            document.getElementById('change-password-item').addEventListener('click', () => showModal('change-password-modal'));
            document.getElementById('close-change-password-modal-btn').addEventListener('click', () => showModal('change-password-modal', false));
            document.getElementById('save-new-password-btn').addEventListener('click', () => {
                const errDiv = document.getElementById('change-password-error');
                const currPass = document.getElementById('current-password-input').value;
                const newPass = document.getElementById('new-password-input').value;
                const confirmPass = document.getElementById('confirm-password-input').value;
                if(!currPass || !newPass || !confirmPass) { errDiv.textContent = "All fields are required."; return; }
                if(newPass !== confirmPass) { errDiv.textContent = "New passwords do not match."; return; }
                const user = auth.currentUser;
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, currPass);
                user.reauthenticateWithCredential(credential).then(() => {
                    return user.updatePassword(newPass);
                }).then(() => {
                    alert("Password updated successfully!");
                    showModal('change-password-modal', false);
                }).catch((error) => {
                    errDiv.textContent = error.message;
                });
            });
            document.getElementById('forgot-password-link').addEventListener('click', () => {
                if (confirm("Send a password reset link to your email?")) {
                    auth.sendPasswordResetEmail(auth.currentUser.email)
                    .then(() => alert("Password reset email sent! Check your inbox."))
                    .catch(err => alert("Error: " + err.message));
                }
            });

            document.getElementById('change-dob-item').addEventListener('click', () => {
                if (currentUser.dobChanged) {
                    alert("You can only change your date of birth once.");
                    return;
                }
                const newDob = prompt("Enter your new Date of Birth (YYYY-MM-DD):", currentUser.dob);
                if (newDob) {
                    db.ref(`users/${currentUser.uid}`).update({ dob: newDob, dobChanged: true })
                    .then(() => alert("Date of Birth updated successfully."))
                    .catch(err => alert("Error: " + err.message));
                }
            });

            document.getElementById('change-gender-item').addEventListener('click', () => {
                if (currentUser.genderChanged) {
                    alert("You can only change your gender once.");
                    return;
                }
                const newGender = prompt("Enter your gender (male, female, other):", currentUser.gender);
                if (newGender && ['male', 'female', 'other'].includes(newGender.toLowerCase())) {
                    db.ref(`users/${currentUser.uid}`).update({ gender: newGender, genderChanged: true })
                    .then(() => alert("Gender updated successfully."))
                    .catch(err => alert("Error: " + err.message));
                } else if(newGender) {
                    alert("Invalid gender. Please enter 'male', 'female', or 'other'.")
                }
            });
            document.getElementById('copy-profile-url-item').addEventListener('click', () => {
                 const profileUrl = `${window.location.origin}${window.location.pathname}#user-profile-view?id=${currentUser.uid}`;
                 navigator.clipboard.writeText(profileUrl)
                    .then(() => alert('Profile URL copied to clipboard!'))
                    .catch(() => alert('Failed to copy URL.'));
            });
            
            document.getElementById('referral-program-item').addEventListener('click', () => {
                 document.getElementById('referral-code-input').value = currentUser.jgId;
                 const appUrl = window.location.origin + window.location.pathname;
                 document.getElementById('referral-link-input').value = `${appUrl}?ref=${currentUser.jgId}`;
                 showModal('referral-modal'); 
            });
            document.getElementById('close-referral-modal-btn').addEventListener('click', () => showModal('referral-modal', false));
            document.getElementById('copy-referral-code-btn').addEventListener('click', (e) => { navigator.clipboard.writeText(document.getElementById('referral-code-input').value); e.target.textContent = "Copied!"; setTimeout(() => e.target.textContent = "Copy", 1500); });
            document.getElementById('copy-referral-link-btn').addEventListener('click', (e) => { navigator.clipboard.writeText(document.getElementById('referral-link-input').value); e.target.textContent = "Copied!"; setTimeout(() => e.target.textContent = "Copy", 1500); });
            document.getElementById('add-friend-item').addEventListener('click', () => showModal('add-friend-modal'));
        }
        
        // --- WALLET ACTIONS ---
        function setupWalletActionListeners() {
            document.getElementById('reload-history-btn').addEventListener('click', renderWalletView);
            document.getElementById('download-history-btn').addEventListener('click', downloadHistory);
            document.getElementById('withdraw-money-btn').addEventListener('click', () => {
                document.getElementById('withdraw-available-balance').textContent = `$${(currentUser.wallet.main || 0).toFixed(2)}`;
                document.getElementById('withdraw-error').textContent = '';
                showModal('withdraw-modal');
            });
            document.getElementById('close-withdraw-modal-btn').addEventListener('click', () => showModal('withdraw-modal', false));
            document.getElementById('submit-withdraw-request-btn').addEventListener('click', submitWithdrawRequest);
        }

        async function downloadHistory() {
            const historyRef = db.ref(`transactionHistory/${currentUser.uid}`).orderByChild('timestamp');
            const snapshot = await historyRef.once('value');
            if (!snapshot.exists()) {
                alert("No transaction history to download.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Timestamp,Reason,Amount,Type\r\n";

            snapshot.forEach(txSnap => {
                const tx = txSnap.val();
                const date = new Date(tx.timestamp).toLocaleString();
                const reason = `"${tx.reason.replace(/"/g, '""')}"`;
                const amount = tx.amount.toFixed(2);
                const type = tx.amount > 0 ? "Credit" : "Debit";
                csvContent += [date, reason, amount, type].join(",") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "mygram_transaction_history.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function submitWithdrawRequest() {
            const errDiv = document.getElementById('withdraw-error');
            const amount = parseFloat(document.getElementById('withdraw-amount-input').value);
            const method = document.getElementById('withdraw-method-select').value;
            const accountNumber = document.getElementById('withdraw-account-input').value.trim();
            const mainBalance = currentUser.wallet.main || 0;
            const minWithdraw = 10;
            
            errDiv.textContent = "";
            if(isNaN(amount) || amount <= 0) { errDiv.textContent = "Please enter a valid amount."; return; }
            if(amount < minWithdraw) { errDiv.textContent = `Minimum withdrawal is $${minWithdraw}.`; return; }
            if(amount > mainBalance) { errDiv.textContent = "Insufficient main balance."; return; }
            if(!accountNumber) { errDiv.textContent = "Please enter your account number."; return; }

            const requestData = {
                userId: currentUser.uid,
                userName: currentUser.name,
                amount: amount,
                method: method,
                accountNumber: accountNumber,
                status: 'pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            try {
                await db.ref('withdrawRequests').push(requestData);
                alert("Withdrawal request submitted successfully! It will be processed soon.");
                showModal('withdraw-modal', false);
            } catch (err) {
                errDiv.textContent = "Could not submit request. Please try again.";
            }
        }

        // --- DIRECT MESSAGING (DM) ---
        // UPDATE: Real-time unread conversation counting
        function listenForDms() {
            const conversationsRef = db.ref(`users/${currentUser.uid}/conversations`);
            conversationsRef.on('value', (snapshot) => {
                let unreadConvoCount = 0;
                if (snapshot.exists()) {
                    snapshot.forEach(convoSnap => {
                        const convo = convoSnap.val();
                        if (convo.unreadCount && convo.unreadCount > 0) {
                            unreadConvoCount++;
                        }
                    });
                }
                const badge = document.getElementById('dm-badge');
                if (unreadConvoCount > 0) {
                    const displayCount = unreadConvoCount > 99 ? '99+' : unreadConvoCount;
                    badge.textContent = displayCount;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            });
        }
        
        async function renderDmList() {
            const container = document.getElementById('dm-list-container');
            container.innerHTML = ''; 

            const contacts = currentUser.contacts || {};
            if (Object.keys(contacts).length === 0) {
                container.innerHTML = '<p style="text-align:center; color: #667781; padding: 40px 20px;">You have no friends yet. Add friends to start chatting.</p>';
                return;
            }
            
            db.ref(`users/${currentUser.uid}/conversations`).off();
            Object.keys(contacts).forEach(userId => {
                db.ref(`users/${userId}`).off();
                db.ref(`/status/${userId}`).off();
            });

            for (const userId of Object.keys(contacts)) {
                const userSnap = await db.ref(`users/${userId}`).once('value');
                if (!userSnap.exists()) continue;

                const userData = userSnap.val();
                const convId = currentUser.uid < userId ? `${currentUser.uid}_${userId}` : `${userId}_${currentUser.uid}`;
                
                const userHasBadge = userData.badgeInfo && userData.badgeInfo.expiryTimestamp > Date.now();
                const badgeIcon = getBlueBadgeIcon(userHasBadge);

                const listItem = document.createElement('div');
                listItem.id = `dm-item-${userId}`;
                listItem.className = 'list-item';
                listItem.innerHTML = `
                    <div class="list-item-profile-img-container">
                        <img src="${userData.profileImageUrl}" class="list-item-profile-img">
                        <div id="dm-list-indicator-${userId}" class="online-indicator"></div>
                    </div>
                    <div class="list-item-details">
                        <div class="list-item-name">${escapeHTML(userData.name)} ${badgeIcon}</div>
                        <div class="list-item-subtext" id="dm-last-msg-${userId}">Tap to start chatting</div>
                    </div>`;
                listItem.onclick = () => openDmChat(userId, userData);
                container.appendChild(listItem);

                const lastMsgElem = document.getElementById(`dm-last-msg-${userId}`);
                db.ref(`users/${currentUser.uid}/conversations/${convId}`).on('value', convSnap => {
                    const convData = convSnap.val();
                    if (lastMsgElem && convData && convData.lastMessage) {
                        lastMsgElem.textContent = escapeHTML(convData.lastMessage);
                        if(convData.unreadCount > 0){
                           lastMsgElem.style.fontWeight = 'bold';
                           lastMsgElem.style.color = 'var(--wa-text-primary)';
                        } else {
                           lastMsgElem.style.fontWeight = 'normal';
                           lastMsgElem.style.color = 'var(--wa-text-secondary)';
                        }
                    }
                });

                const statusIndicator = document.getElementById(`dm-list-indicator-${userId}`);
                db.ref(`/status/${userId}`).on('value', statusSnap => {
                    if (statusIndicator) {
                        statusIndicator.style.display = (statusSnap.exists() && statusSnap.val().state === 'online') ? 'block' : 'none';
                    }
                });
            }
        }
        
        async function openDmChat(otherUserId, otherUserData) {
            currentDmPartner = { uid: otherUserId, ...otherUserData };
            const messagesContainer = document.getElementById('dm-chat-messages');
            messagesContainer.innerHTML = '';
            
            const partnerHasBadge = currentDmPartner.badgeInfo && currentDmPartner.badgeInfo.expiryTimestamp > Date.now();
            const badgeIcon = getBlueBadgeIcon(partnerHasBadge);
            
            document.getElementById('dm-chat-header-img').src = currentDmPartner.profileImageUrl;
            document.getElementById('dm-chat-header-name').innerHTML = `${escapeHTML(currentDmPartner.name)} ${badgeIcon}`;
            
            const statusIndicator = document.getElementById('dm-chat-online-indicator');
            const statusText = document.getElementById('dm-chat-header-subtext');

            db.ref(`/status/${otherUserId}`).on('value', statusSnap => {
                if (statusSnap.exists() && statusSnap.val().state === 'online') {
                    statusIndicator.style.display = 'block';
                    statusText.textContent = 'online';
                    statusText.className = 'list-item-subtext online';
                } else {
                    statusIndicator.style.display = 'none';
                    statusText.textContent = 'offline';
                     statusText.className = 'list-item-subtext offline';
                }
            });

            showView('dm-chat-view');

            const myUid = currentUser.uid;
            const convId = myUid < otherUserId ? `${myUid}_${otherUserId}` : `${otherUserId}_${myUid}`;
            
            db.ref(`users/${myUid}/conversations/${convId}/unreadCount`).set(0);

            const messagesRef = db.ref(`direct_messages/${convId}`);
            
            messagesRef.limitToLast(50).on('child_added', (snapshot) => {
                renderDmMessage(snapshot, convId);
                // Mark as seen immediately if the message is not from the current user
                if(snapshot.val().sender !== myUid) {
                    db.ref(`direct_messages/${convId}/${snapshot.key}/seenBy/${myUid}`).set(firebase.database.ServerValue.TIMESTAMP);
                }
            });
            messagesRef.on('child_changed', (snapshot) => {
                renderDmMessage(snapshot, convId, true);
            });
        }

        
        function renderDmMessage(snapshot, convId, isUpdate = false) {
            const messagesContainer = document.getElementById('dm-chat-messages');
            const msgId = snapshot.key;
            const msg = snapshot.val();
            
            let div = document.getElementById(`msg-${msgId}`);
            if (!div) {
                div = document.createElement('div');
                div.id = `msg-${msgId}`;
            } else if (!isUpdate) {
                return;
            }
            
            const isMyMessage = msg.sender === currentUser.uid;
            const messageClass = isMyMessage ? 'message-sent' : 'message-received';
            div.className = 'message-bubble ' + messageClass;
            
            if(msg.deleted) {
                div.classList.add('deleted');
                div.innerHTML = isMyMessage ? 'You deleted this message' : 'This message was deleted';
                 if (!isUpdate || !messagesContainer.contains(div)) messagesContainer.appendChild(div);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                return;
            }

            let contentHTML = '';
            if (msg.type === 'image' && msg.imageUrl) {
                contentHTML += `<div class="image-container-for-chat"><img src="${msg.imageUrl}" class="chat-image" onclick="viewPostImage('${msg.imageUrl}')"><a href="${msg.imageUrl}" download="image.jpg" class="image-download-btn" title="Download Image"><svg viewBox="0 0 24 24" fill="white" width="18px" height="18px"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg></a></div>`;
            }
            if (msg.text) {
                contentHTML += `<div id="text-${msgId}">${linkify(msg.text)}</div>`;
            }

            let menuHTML = '';
            if(isMyMessage) {
                menuHTML = `<div class="message-menu-trigger" onclick="event.stopPropagation(); this.nextElementSibling.style.display = 'block';">...</div><div class="message-menu">${msg.text ? `<button onclick="startEditDmMessage('${msgId}')">Edit</button>` : ''}<button onclick="deleteDmMessage('${msgId}', '${convId}')">Delete</button></div>`;
            }
            
            const editedLabel = msg.edited ? '<span class="edited-label">(Edited)</span>' : '';
            
            let seenIndicatorHTML = '';
            if (isMyMessage && msg.seenBy && msg.seenBy[currentDmPartner.uid]) {
                seenIndicatorHTML = `<img src="${currentDmPartner.profileImageUrl}" class="message-seen-indicator" title="Seen">`;
            }
            
            div.innerHTML = `<div class="message-content-wrapper">${contentHTML}${menuHTML}</div><div class="message-meta">${editedLabel} ${new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} ${seenIndicatorHTML}</div>`;
            
            if (!isUpdate || !messagesContainer.contains(div)) {
                 messagesContainer.appendChild(div);
            }
           
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        window.startEditDmMessage = (msgId) => {
            const textDiv = document.getElementById(`text-${msgId}`);
            const currentText = textDiv.innerText;
            textDiv.innerHTML = `<textarea id="edit-msg-${msgId}" style="width:100%; min-height: 50px;">${currentText}</textarea><button onclick="saveEditDmMessage('${msgId}')">Save</button><button onclick="cancelEditDmMessage('${msgId}', \`${escapeHTML(currentText).replace(/`/g, "\\`")}\`)">Cancel</button>`;
        };

        window.saveEditDmMessage = (msgId) => {
            const myUid = currentUser.uid;
            const otherUserId = currentDmPartner.uid;
            const convId = myUid < otherUserId ? `${myUid}_${otherUserId}` : `${otherUserId}_${myUid}`;
            const newText = document.getElementById(`edit-msg-${msgId}`).value;
            db.ref(`direct_messages/${convId}/${msgId}`).update({ text: newText, edited: true });
        };
        
        window.cancelEditDmMessage = (msgId, originalText) => {
            document.getElementById(`text-${msgId}`).innerHTML = linkify(originalText);
        }

        window.deleteDmMessage = (msgId, convId) => {
            if (confirm("Are you sure you want to delete this message for everyone?")) {
                const messageRef = db.ref(`direct_messages/${convId}/${msgId}`);
                messageRef.update({
                    text: null,
                    imageUrl: null,
                    type: null,
                    deleted: true
                });
                const lastMessageText = "Message deleted";
                db.ref(`users/${currentUser.uid}/conversations/${convId}/lastMessage`).set(lastMessageText);
                db.ref(`users/${currentDmPartner.uid}/conversations/${convId}/lastMessage`).set(lastMessageText);
            }
        };

        async function sendDmMessage(textOverride = null, imageUrl = null) {
            const input = document.getElementById('dm-chat-input');
            const text = textOverride || input.value.trim();
            if(!text && !imageUrl || !currentDmPartner) return;
            
            const myUid = currentUser.uid;
            const otherUserId = currentDmPartner.uid;
            const convId = myUid < otherUserId ? `${myUid}_${otherUserId}` : `${otherUserId}_${myUid}`;
            
            const messageData = {
                sender: myUid,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            if(text) messageData.text = text;
            if(imageUrl) {
                messageData.imageUrl = imageUrl;
                messageData.type = 'image';
            }

            const lastMessageText = imageUrl ? '[Image]' : text;
            const updates = {};
            const newMessageKey = db.ref(`direct_messages/${convId}`).push().key;
            updates[`direct_messages/${convId}/${newMessageKey}`] = messageData;
            updates[`users/${myUid}/conversations/${convId}`] = { lastMessage: lastMessageText, timestamp: firebase.database.ServerValue.TIMESTAMP, unreadCount: 0 };
            updates[`users/${otherUserId}/conversations/${convId}/lastMessage`] = lastMessageText;
            updates[`users/${otherUserId}/conversations/${convId}/timestamp`] = firebase.database.ServerValue.TIMESTAMP;
            updates[`users/${otherUserId}/conversations/${convId}/unreadCount`] = firebase.database.ServerValue.increment(1);

            await db.ref().update(updates);
            
            if(!textOverride && !imageUrl) {
                 input.value = '';
                 input.style.height = 'auto';
            }
        }
        
        document.getElementById('dm-attach-btn').addEventListener('click', () => { document.getElementById('dm-image-input').click(); });
        document.getElementById('dm-image-input').addEventListener('change', (e) => { const file = e.target.files[0]; if (!file || !currentDmPartner) return; chatImageFile = file; const reader = new FileReader(); reader.onload = (event) => { document.getElementById('image-preview-send-src').src = event.target.result; showModal('image-preview-send-modal'); }; reader.readAsDataURL(file); e.target.value = ''; });
        document.getElementById('cancel-send-image-btn').addEventListener('click', () => { chatImageFile = null; showModal('image-preview-send-modal', false); });
        
        document.getElementById('confirm-send-image-btn').addEventListener('click', async () => {
            if (!chatImageFile) return;
            const sendBtn = document.getElementById('confirm-send-image-btn');
            const originalText = sendBtn.innerHTML;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="loader-small"></div>';

            try {
                const imageUrl = await uploadImage(chatImageFile);
                if (imageUrl) {
                    if (currentView === 'dm-chat-view' && currentDmPartner) {
                        await sendDmMessage(null, imageUrl);
                    }
                }
            } catch(e) {
                alert("Image could not be sent.");
            } finally {
                chatImageFile = null;
                showModal('image-preview-send-modal', false);
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalText;
            }
        });

        document.getElementById('dm-chat-send-btn').addEventListener('click', () => sendDmMessage());
        document.getElementById('dm-chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendDmMessage(); } });
        
        // --- Watch Section & Video Modal ---
        function renderWatchContent() {
            const container = document.getElementById('watch-content');
            container.innerHTML = '<p style="text-align:center; padding: 20px;">Loading videos...</p>';

            const videoPostsRef = db.ref('posts').orderByChild('hasVideo').equalTo(true);
            
            videoPostsRef.off(); // আগের লিসেনার থাকলে রিমুভ করুন

            videoPostsRef.on('value', async (snapshot) => {
                container.innerHTML = '';
                if (!snapshot.exists()) {
                    container.innerHTML = '<p style="text-align:center; color: var(--wa-text-secondary); padding: 50px 20px;">No video posts found.</p>';
                    return;
                }
                
                let videoPosts = [];
                snapshot.forEach(child => {
                    const postData = child.val();
                    // =================== মূল সমাধান এখানে ===================
                    // শুধুমাত্র hasVideo এবং googleDriveId দুটোই থাকলে ভিডিও হিসেবে গণ্য হবে
                    if (postData.hasVideo && postData.googleDriveId) {
                        videoPosts.push({ key: child.key, ...postData });
                    }
                    // =========================================================
                });

                if (videoPosts.length === 0) {
                     container.innerHTML = '<p style="text-align:center; color: var(--wa-text-secondary); padding: 50px 20px;">No valid video posts found.</p>';
                     return;
                }

                videoPosts.reverse(); // নতুন ভিডিও প্রথমে দেখানোর জন্য
                
                for (const post of videoPosts) {
                    const postSnapshot = await db.ref(`posts/${post.key}`).once('value');
                    renderSinglePost(postSnapshot, container, false);
                }
            });
        }
        
        function setupVideoModal() {
            document.getElementById('add-video-btn').addEventListener('click', () => showModal('add-video-modal'));
            document.getElementById('close-add-video-modal-btn').addEventListener('click', () => showModal('add-video-modal', false));
            document.getElementById('submit-video-post-btn').addEventListener('click', async () => {
                const title = document.getElementById('video-title-input').value.trim();
                const gdriveId = document.getElementById('gdrive-id-input').value.trim();
                const thumbnailFile = document.getElementById('video-thumbnail-input').files[0];

                if(!title || !gdriveId) {
                    alert('Please provide both a title and a Google Drive ID.');
                    return;
                }
                if(!thumbnailFile) {
                    alert('Please upload a thumbnail image for the video.');
                    return;
                }

                const postBtn = document.getElementById('submit-video-post-btn');
                postBtn.disabled = true;
                postBtn.innerHTML = '<div class="loader-small"></div>';

                try {
                    const thumbnailUrl = await uploadImage(thumbnailFile);
                    if (!thumbnailUrl) {
                        throw new Error("Thumbnail upload failed.");
                    }

                    const postData = {
                        authorUid: currentUser.uid,
                        authorName: currentUser.name,
                        authorProfileImageUrl: currentUser.profileImageUrl,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        text: title,
                        hasVideo: true,
                        googleDriveId: gdriveId,
                        videoThumbnailUrl: thumbnailUrl
                    };

                    await db.ref('posts').push(postData);
                    alert('Video posted successfully!');
                    showModal('add-video-modal', false);
                    document.getElementById('video-title-input').value = '';
                    document.getElementById('gdrive-id-input').value = '';
                    document.getElementById('video-thumbnail-input').value = '';
                    // The 'on' listener in renderWatchContent will now automatically handle the update.

                } catch(err) {
                    alert('Failed to post video. ' + err.message);
                } finally {
                    postBtn.disabled = false;
                    postBtn.textContent = "Post Video";
                }
            });
        }

    </script>
</body>
</html>